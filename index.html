<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":true,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="czh的学习小站">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="czh的学习小站">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="蔡正海">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>czh的学习小站</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">czh的学习小站</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">自律</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="蔡正海"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">蔡正海</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">38</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/project/openai/openai1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/project/openai/openai1/" class="post-title-link" itemprop="url">【1开发】AI问答助手项目记录1 - 用户登陆鉴权</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E9%A1%B9%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">项目</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E9%A1%B9%E7%9B%AE/AI%E9%97%AE%E7%AD%94%E5%8A%A9%E6%89%8B/" itemprop="url" rel="index"><span itemprop="name">AI问答助手</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="整体结构引言"><a href="#整体结构引言" class="headerlink" title="整体结构引言"></a>整体结构引言</h2><p>目前的大模型不管是chatgpt，还是国内的类似kimi都需要开发一个系统界面，便于用户的使用。</p>
<p>AI问答助手应该实现两个核心逻辑：一个是各类大模型的对接；一个是用户的聊天系统，包含用户登陆、鉴权。</p>
<h2 id="用户登陆鉴权"><a href="#用户登陆鉴权" class="headerlink" title="用户登陆鉴权"></a>用户登陆鉴权</h2><p>我们先处理第一步，用户如何进行登陆鉴权。我们选择通过微信公众号验证码的方式登陆。</p>
<h3 id="第一步，公众号接入"><a href="#第一步，公众号接入" class="headerlink" title="第一步，公众号接入"></a>第一步，公众号接入</h3><p>要用公众号验证码的方式登陆，我们首先得从公众号拿到验证码。公众号的配置和实现还是比较固定的：验签和请求应答。（当然，别忘了在公众号官网的配置页面里把请求地址设置好）</p>
<h4 id="验签"><a href="#验签" class="headerlink" title="验签"></a>验签</h4><p>这个流程是固定的，网上直接找份代码就行。其实就是</p>
<ol>
<li>公众号端传来的参数：时间戳、随机数、签名。</li>
<li>将时间戳、随机数、和本机保存的token一起做一个SHA-1</li>
<li>最后和签名比较</li>
</ol>
<img src="https://raw.githubusercontent.com/cccccc96/cloudimg/main/image-20240703233559214.png" alt="image-20240703233559214" style="zoom:50%;" />

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(produces = &quot;text/plain;charset=utf-8&quot;)</span><br><span class="line">public String validate(@PathVariable String appid,</span><br><span class="line">                       @RequestParam(value = &quot;signature&quot;, required = false) String signature,</span><br><span class="line">                       @RequestParam(value = &quot;timestamp&quot;, required = false) String timestamp,</span><br><span class="line">                       @RequestParam(value = &quot;nonce&quot;, required = false) String nonce,</span><br><span class="line">                       @RequestParam(value = &quot;echostr&quot;, required = false) String echostr) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        log.info(&quot;微信公众号验签信息&#123;&#125;开始 [&#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;]&quot;, appid, signature, timestamp, nonce, echostr);</span><br><span class="line">        if (StringUtils.isAnyBlank(signature, timestamp, nonce, echostr)) &#123;</span><br><span class="line">            throw new IllegalArgumentException(&quot;请求参数非法，请核实!&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        boolean check = weiXinValidateService.checkSign(signature, timestamp, nonce);</span><br><span class="line">        log.info(&quot;微信公众号验签信息&#123;&#125;完成 check：&#123;&#125;&quot;, appid, check);</span><br><span class="line">        if (!check) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        return echostr;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        log.error(&quot;微信公众号验签信息&#123;&#125;失败 [&#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;]&quot;, appid, signature, timestamp, nonce, echostr, e);</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="消息请求（处理验证码）"><a href="#消息请求（处理验证码）" class="headerlink" title="消息请求（处理验证码）"></a>消息请求（处理验证码）</h4><p>用户发一个消息，我们要生成一个随机数（验证码）返回给用户的同时，保存进Redis。用于后续用户在网页端输入验证码，我们要进行确认，验证码是否有效。</p>
<p>当我们接收到公众号发来的请求</p>
<ul>
<li>生成验证码</li>
<li>openid和验证码 进行缓存</li>
<li>返回给公众号验证码</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生成验证码</span></span><br><span class="line"><span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> repository.genCode(userBehaviorMessageEntity.getOpenId());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 反馈信息[文本]</span></span><br><span class="line"><span class="type">MessageTextEntity</span> <span class="variable">res</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageTextEntity</span>();</span><br><span class="line">res.setToUserName(userBehaviorMessageEntity.getOpenId());</span><br><span class="line">res.setFromUserName(originalId);</span><br><span class="line">res.setCreateTime(String.valueOf(System.currentTimeMillis() / <span class="number">1000L</span>));</span><br><span class="line">res.setMsgType(<span class="string">&quot;text&quot;</span>);</span><br><span class="line">res.setContent(String.format(<span class="string">&quot;您的验证码为：%s 有效期%d分钟！&quot;</span>, code, <span class="number">3</span>));</span><br><span class="line"><span class="keyword">return</span> XmlUtil.beanToXml(res);</span><br></pre></td></tr></table></figure>

<p>（验证码防重）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">public String genCode(String openId) &#123;</span><br><span class="line">        // 获取值</span><br><span class="line">        String isExitCode = redisService.getValue(Key + &quot;_&quot; + openId);</span><br><span class="line">        if (StringUtils.isNotBlank(isExitCode)) return isExitCode;</span><br><span class="line">        // 生成值</span><br><span class="line">        RLock lock = redisService.getLock(Key);</span><br><span class="line">        try &#123;</span><br><span class="line">            lock.lock(15, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">            String code = RandomStringUtils.randomNumeric(4);</span><br><span class="line">            // 防重校验&amp;重新生成</span><br><span class="line">            for (int i = 0; i &lt; 10 &amp;&amp; StringUtils.isNotBlank(redisService.getValue(Key + &quot;_&quot; + code)); i++) &#123;</span><br><span class="line">                if (i &lt; 3) &#123;</span><br><span class="line">                    code = RandomStringUtils.randomNumeric(4);</span><br><span class="line">                &#125; else if (i &lt; 5) &#123;</span><br><span class="line">                    code = RandomStringUtils.randomNumeric(5);</span><br><span class="line">                &#125; else if (i &lt; 9) &#123;</span><br><span class="line">                    code = RandomStringUtils.randomNumeric(6);</span><br><span class="line">                    log.warn(&quot;验证码重复，生成6位字符串验证码 &#123;&#125; &#123;&#125;&quot;, openId, code);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    return &quot;您的验证码获取失败，请重新回复405获取。&quot;;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // 存储值【3分钟有效期】</span><br><span class="line">            redisService.setValue(Key + &quot;_&quot; + code, openId, 3 * 60 * 1000);</span><br><span class="line">            redisService.setValue(Key + &quot;_&quot; + openId, code);</span><br><span class="line"></span><br><span class="line">            return code;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="第二步，用户拿到验证码后输入"><a href="#第二步，用户拿到验证码后输入" class="headerlink" title="第二步，用户拿到验证码后输入"></a>第二步，用户拿到验证码后输入</h2><p>用户输入验证码，点击确认，发送一个auth请求，我们拿到请求后，就可以根据验证码进行确认。</p>
<ul>
<li>检查验证码（是否在缓存中）</li>
<li>jwt生成token并返回（根据openid生成token）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> AuthStateEntity <span class="title function_">doLogin</span><span class="params">(String code)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 校验判断，非成功则直接返回</span></span><br><span class="line">    <span class="type">AuthStateEntity</span> <span class="variable">authStateEntity</span> <span class="operator">=</span> <span class="built_in">this</span>.checkCode(code);</span><br><span class="line">    <span class="keyword">if</span> (!authStateEntity.getCode().equals(AuthTypeVO.A0000.getCode())) &#123;</span><br><span class="line">        <span class="keyword">return</span> authStateEntity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 获取 Token 并返回</span></span><br><span class="line">    Map&lt;String, Object&gt; chaim = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    chaim.put(<span class="string">&quot;openId&quot;</span>, authStateEntity.getOpenId());</span><br><span class="line">    <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> encode(authStateEntity.getOpenId(), <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>, chaim);</span><br><span class="line">    authStateEntity.setToken(token);</span><br><span class="line">    log.info(<span class="string">&quot;encode token : &#123;&#125;&quot;</span>,token);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> authStateEntity;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>验证码去缓存中确认</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> AuthStateEntity <span class="title function_">checkCode</span><span class="params">(String code)</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;codeCache ： &#123;&#125;&quot;</span>, JSON.toJSONString(codeCache.asMap()));</span><br><span class="line">    <span class="comment">// 获取验证码校验</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">openId</span> <span class="operator">=</span> codeCache.getIfPresent(code);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(openId))&#123;</span><br><span class="line">        log.info(<span class="string">&quot;鉴权，用户输入的验证码不存在 &#123;&#125;&quot;</span>, code);</span><br><span class="line">        <span class="keyword">return</span> AuthStateEntity.builder()</span><br><span class="line">                .code(AuthTypeVO.A0001.getCode())</span><br><span class="line">                .info(AuthTypeVO.A0001.getInfo())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">// 移除缓存Key值</span></span><br><span class="line">    codeCache.invalidate(openId);</span><br><span class="line">    codeCache.invalidate(code);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证码校验成功</span></span><br><span class="line">    <span class="keyword">return</span> AuthStateEntity.builder()</span><br><span class="line">            .code(AuthTypeVO.A0000.getCode())</span><br><span class="line">            .info(AuthTypeVO.A0000.getInfo())</span><br><span class="line">            .openId(openId)</span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>jwt 编码（用openid进行编码）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 这里就是产生jwt字符串的地方</span></span><br><span class="line"><span class="comment"> * jwt字符串包括三个部分</span></span><br><span class="line"><span class="comment"> * 1. header</span></span><br><span class="line"><span class="comment"> * -当前字符串的类型，一般都是“JWT”</span></span><br><span class="line"><span class="comment"> * -哪种算法加密，“HS256”或者其他的加密算法</span></span><br><span class="line"><span class="comment"> * 所以一般都是固定的，没有什么变化</span></span><br><span class="line"><span class="comment"> * 2. payload</span></span><br><span class="line"><span class="comment"> * 一般有四个最常见的标准字段（下面有）</span></span><br><span class="line"><span class="comment"> * iat：签发时间，也就是这个jwt什么时候生成的</span></span><br><span class="line"><span class="comment"> * jti：JWT的唯一标识</span></span><br><span class="line"><span class="comment"> * iss：签发人，一般都是username或者userId</span></span><br><span class="line"><span class="comment"> * exp：过期时间</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> String <span class="title function_">encode</span><span class="params">(String issuer, <span class="type">long</span> ttlMillis, Map&lt;String, Object&gt; claims)</span> &#123;</span><br><span class="line">    <span class="comment">// iss签发人，ttlMillis生存时间，claims是指还想要在jwt中存储的一些非隐私信息</span></span><br><span class="line">    <span class="keyword">if</span> (claims == <span class="literal">null</span>) &#123;</span><br><span class="line">        claims = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="variable">nowMillis</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    <span class="type">JwtBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> Jwts.builder()</span><br><span class="line">            <span class="comment">// 荷载部分</span></span><br><span class="line">            .setClaims(claims)</span><br><span class="line">            <span class="comment">// 这个是JWT的唯一标识，一般设置成唯一的，这个方法可以生成唯一标识</span></span><br><span class="line">            .setId(UUID.randomUUID().toString())<span class="comment">//2.</span></span><br><span class="line">            <span class="comment">// 签发时间</span></span><br><span class="line">            .setIssuedAt(<span class="keyword">new</span> <span class="title class_">Date</span>(nowMillis))</span><br><span class="line">            <span class="comment">// 签发人，也就是JWT是给谁的（逻辑上一般都是username或者userId）</span></span><br><span class="line">            .setSubject(issuer)</span><br><span class="line">            .signWith(SignatureAlgorithm.HS256, base64EncodedSecretKey);<span class="comment">//这个地方是生成jwt使用的算法和秘钥</span></span><br><span class="line">    <span class="keyword">if</span> (ttlMillis &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">expMillis</span> <span class="operator">=</span> nowMillis + ttlMillis;</span><br><span class="line">        <span class="type">Date</span> <span class="variable">exp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>(expMillis);<span class="comment">// 4. 过期时间，这个也是使用毫秒生成的，使用当前时间+前面传入的持续时间生成</span></span><br><span class="line">        builder.setExpiration(exp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> builder.compact();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Token和cookie的区别（待看）"><a href="#Token和cookie的区别（待看）" class="headerlink" title="Token和cookie的区别（待看）"></a>Token和cookie的区别（待看）</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/project/openai/openai2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/project/openai/openai2/" class="post-title-link" itemprop="url">【1开发】AI问答助手项目记录2 - 大模型api</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E9%A1%B9%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">项目</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E9%A1%B9%E7%9B%AE/AI%E9%97%AE%E7%AD%94%E5%8A%A9%E6%89%8B/" itemprop="url" rel="index"><span itemprop="name">AI问答助手</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="通过okhttp为大模型自己实现一个api"><a href="#通过okhttp为大模型自己实现一个api" class="headerlink" title="通过okhttp为大模型自己实现一个api"></a>通过okhttp为大模型自己实现一个api</h2><p>涉及到的技术栈：okhttp3、Jackson</p>
<img src="https://raw.githubusercontent.com/cccccc96/cloudimg/main/image-20240704115618698.png" alt="image-20240704115618698" style="zoom: 50%;" />

<h2 id="chatglm请求里的几个核心字段"><a href="#chatglm请求里的几个核心字段" class="headerlink" title="chatglm请求里的几个核心字段"></a>chatglm请求里的几个核心字段</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 模型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">Model</span> <span class="variable">model</span> <span class="operator">=</span> Model.GLM_3_5_TURBO;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 请求参数 &#123;&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;你好&quot;&#125;</span></span><br><span class="line"><span class="comment"> * 24年1月发布的 GLM_3_5_TURBO、GLM_4 模型时新增</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> List&lt;Prompt&gt; messages;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 请求ID</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@JsonProperty(&quot;request_id&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">requestId</span> <span class="operator">=</span> String.format(<span class="string">&quot;czh-%d&quot;</span>, System.currentTimeMillis());</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * do_sample 为 true 时启用采样策略，do_sample 为 false 时采样策略 temperature、top_p 将不生效</span></span><br><span class="line"><span class="comment"> * 24年1月发布的 GLM_3_5_TURBO、GLM_4 模型时新增</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@JsonProperty(&quot;do_sample&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">Boolean</span> <span class="variable">doSample</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用同步调用时，此参数应当设置为 Fasle 或者省略。表示模型生成完所有内容后一次性返回所有内容。</span></span><br><span class="line"><span class="comment"> * 如果设置为 True，模型将通过标准 Event Stream ，逐块返回模型生成内容。Event Stream 结束时会返回一条data: [DONE]消息。</span></span><br><span class="line"><span class="comment"> * 24年1月发布的 GLM_3_5_TURBO、GLM_4 模型时新增</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">Boolean</span> <span class="variable">stream</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>



<h2 id="整体结构"><a href="#整体结构" class="headerlink" title="整体结构"></a>整体结构</h2><p>本质上，我们要开启一个openai会话，需要做以下几件事</p>
<ol>
<li>开启一个OkHttpClient<ol>
<li>设置拦截器（因为要写入大模型token）</li>
</ol>
</li>
<li>通过Retrofit封装OkHttp（方便测试）</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 开启 Http 客户端</span></span><br><span class="line"><span class="type">OkHttpClient</span> <span class="variable">okHttpClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span></span><br><span class="line">        .Builder()</span><br><span class="line">        .addInterceptor(httpLoggingInterceptor)</span><br><span class="line">        .addInterceptor(<span class="keyword">new</span> <span class="title class_">OpenAiHTTPInterceptor</span>(configuration))</span><br><span class="line">        .connectTimeout(configuration.getConnectTimeout(), TimeUnit.SECONDS)</span><br><span class="line">        .writeTimeout(configuration.getWriteTimeout(), TimeUnit.SECONDS)</span><br><span class="line">        .readTimeout(configuration.getReadTimeout(), TimeUnit.SECONDS)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">configuration.setOkHttpClient(okHttpClient);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 创建 API 服务</span></span><br><span class="line"><span class="type">IOpenAiApi</span> <span class="variable">openAiApi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Retrofit</span>.Builder()</span><br><span class="line">        .baseUrl(configuration.getApiHost())</span><br><span class="line">        .client(okHttpClient)</span><br><span class="line">        .addCallAdapterFactory(RxJava2CallAdapterFactory.create())</span><br><span class="line">        .addConverterFactory(JacksonConverterFactory.create())</span><br><span class="line">        .build().create(IOpenAiApi.class);</span><br><span class="line"></span><br><span class="line">configuration.setOpenAiApi(openAiApi);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 实例化执行器</span></span><br><span class="line">HashMap&lt;Model, Executor&gt; executorGroup = configuration.newExecutorGroup();</span><br></pre></td></tr></table></figure>

<h2 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h2><p>实现okhttp3.Interceptor的拦截器。</p>
<p>在用户调用sdk时拦截，并传入用户自定义的apikey</p>
<p>也就是加上Authorization字段，这也是大模型通用的做法（对于这里的chatglm而言，我们还需要对apikey进行jwt编码）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@NotNull</span> Response <span class="title function_">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 1. 获取原始 Request</span></span><br><span class="line">        <span class="type">Request</span> <span class="variable">original</span> <span class="operator">=</span> chain.request();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 构建请求</span></span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> original.newBuilder()</span><br><span class="line">                .url(original.url())</span><br><span class="line">                .header(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;Bearer &quot;</span> + BearerTokenUtils.getToken(configuration.getApiKey(), configuration.getApiSecret()))</span><br><span class="line">                .header(<span class="string">&quot;Content-Type&quot;</span>, Configuration.JSON_CONTENT_TYPE)</span><br><span class="line">                .header(<span class="string">&quot;User-Agent&quot;</span>, Configuration.DEFAULT_USER_AGENT)</span><br><span class="line"><span class="comment">//                .header(&quot;Accept&quot;, null != original.header(&quot;Accept&quot;) ? original.header(&quot;Accept&quot;) : Configuration.SSE_CONTENT_TYPE)</span></span><br><span class="line">                .method(original.method(), original.body())</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 返回执行结果</span></span><br><span class="line">        <span class="keyword">return</span> chain.proceed(request);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="会话接口-基于eventsource的响应"><a href="#会话接口-基于eventsource的响应" class="headerlink" title="会话接口 - 基于eventsource的响应"></a>会话接口 - 基于eventsource的响应</h2><p>使用eventsource进行流式传输，适用于长时间连接并接收实时更新的情况，接受一个请求对象和事件监听器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> EventSource.Factory factory;</span><br><span class="line"><span class="keyword">public</span> EventSource <span class="title function_">completions</span><span class="params">(ChatCompletionRequest chatCompletionRequest, EventSourceListener eventSourceListener)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 构建请求信息</span></span><br><span class="line">    <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">            .url(configuration.getApiHost().concat(IOpenAiApi.v4))</span><br><span class="line">            .post(RequestBody.create(MediaType.parse(Configuration.JSON_CONTENT_TYPE), chatCompletionRequest.toString()))</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回事件结果</span></span><br><span class="line">    <span class="keyword">return</span> factory.newEventSource(request, chatCompletionRequest.getIsCompatible() ? eventSourceListener(eventSourceListener) : eventSourceListener);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">openAiSession.completions(request, <span class="keyword">new</span> <span class="title class_">EventSourceListener</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onEvent</span><span class="params">(EventSource eventSource, <span class="meta">@Nullable</span> String id, <span class="meta">@Nullable</span> String type, String data)</span> &#123;</span><br><span class="line">                <span class="type">ChatCompletionResponse</span> <span class="variable">response</span> <span class="operator">=</span> JSON.parseObject(data, ChatCompletionResponse.class);</span><br><span class="line">                log.info(<span class="string">&quot;测试结果 onEvent czh：&#123;&#125;&quot;</span>, type);</span><br><span class="line">                log.info(<span class="string">&quot;测试结果 onEvent：&#123;&#125;&quot;</span>, response.getData());</span><br><span class="line">                <span class="comment">// type 消息类型，add 增量，finish 结束，error 错误，interrupted 中断</span></span><br><span class="line">                <span class="keyword">if</span> (EventType.finish.getCode().equals(type)) &#123;</span><br><span class="line">                    ChatCompletionResponse.<span class="type">Meta</span> <span class="variable">meta</span> <span class="operator">=</span> JSON.parseObject(response.getMeta(), ChatCompletionResponse.Meta.class);</span><br><span class="line">                    log.info(<span class="string">&quot;[输出结束] Tokens &#123;&#125;&quot;</span>, JSON.toJSONString(meta));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClosed</span><span class="params">(EventSource eventSource)</span> &#123;</span><br><span class="line">                log.info(<span class="string">&quot;对话完成&quot;</span>);</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(EventSource eventSource, <span class="meta">@Nullable</span> Throwable t, <span class="meta">@Nullable</span> Response response)</span> &#123;</span><br><span class="line">                log.info(<span class="string">&quot;对话异常&quot;</span>);</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/project/openai/openai3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/project/openai/openai3/" class="post-title-link" itemprop="url">【1开发】AI问答助手项目记录3 - 规则过滤</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E9%A1%B9%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">项目</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E9%A1%B9%E7%9B%AE/AI%E9%97%AE%E7%AD%94%E5%8A%A9%E6%89%8B/" itemprop="url" rel="index"><span itemprop="name">AI问答助手</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="规则过滤"><a href="#规则过滤" class="headerlink" title="规则过滤"></a>规则过滤</h2><p>用户在真正调用大模型前，我们需要进行规则过滤，只有满足所有规则，才能真正请求大模型。</p>
<p>规则：敏感词、白名单、频次限制、账户状态、账户额度</p>
<p>这里的实现和抽奖项目一样，采用责任链，为每个规则定义一个过滤实现。</p>
<p>特别地，对于敏感词，我们用hubbo提供的敏感词包进行过滤</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">List&lt;MessageEntity&gt; newMessages = chatProcess.getMessages().stream()</span><br><span class="line">        .map(message -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> message.getContent();</span><br><span class="line">            <span class="type">String</span> <span class="variable">replace</span> <span class="operator">=</span> words.replace(content);</span><br><span class="line">            <span class="keyword">return</span> MessageEntity.builder()</span><br><span class="line">                    .role(message.getRole())</span><br><span class="line">                    .name(message.getName())</span><br><span class="line">                    .content(replace)</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;)</span><br><span class="line">        .collect(Collectors.toList());</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/project/openai/openai4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/project/openai/openai4/" class="post-title-link" itemprop="url">【1开发】AI问答助手项目记录4 - 商品下单</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E9%A1%B9%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">项目</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E9%A1%B9%E7%9B%AE/AI%E9%97%AE%E7%AD%94%E5%8A%A9%E6%89%8B/" itemprop="url" rel="index"><span itemprop="name">AI问答助手</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="商品下单"><a href="#商品下单" class="headerlink" title="商品下单"></a>商品下单</h2><p>这里的商品就是各种大模型次数的额度</p>
<h2 id="步骤1-用户点击购买，创建未支付订单，等待用户支付"><a href="#步骤1-用户点击购买，创建未支付订单，等待用户支付" class="headerlink" title="步骤1 用户点击购买，创建未支付订单，等待用户支付"></a>步骤1 用户点击购买，创建未支付订单，等待用户支付</h2><p>我们主要做两件事：创建订单，请求支付宝支付请求</p>
<ol>
<li>校验token，获取用户id和商品信息，根据用户信息和商品信息创建未支付订单</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;create_pay_order&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="keyword">public</span> Response&lt;String&gt; <span class="title function_">createParOrder</span><span class="params">(<span class="meta">@RequestHeader(&quot;Authorization&quot;)</span> String token, <span class="meta">@RequestParam</span> Integer productId)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. Token 校验</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. Token 解析</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ShopCartEntity</span> <span class="variable">shopCartEntity</span> <span class="operator">=</span> ShopCartEntity.builder()</span><br><span class="line">                .openid(openid)</span><br><span class="line">                .productId(productId).build();</span><br><span class="line"></span><br><span class="line">        <span class="type">PayOrderEntity</span> <span class="variable">payOrder</span> <span class="operator">=</span> orderService.createOrder(shopCartEntity);</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>如果用户存在有效的未支付订单，则直接返回原来的那笔订单；否则的话，创建一笔未支付订单</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> PayOrderEntity <span class="title function_">createOrder</span><span class="params">(ShopCartEntity shopCartEntity)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 0. 基础信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">openid</span> <span class="operator">=</span> shopCartEntity.getOpenid();</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">productId</span> <span class="operator">=</span> shopCartEntity.getProductId();</span><br><span class="line">        <span class="comment">// 1. 查询有效的未支付订单，如果存在直接返回现成的</span></span><br><span class="line">        <span class="comment">// 2. 商品查询</span></span><br><span class="line">        <span class="comment">// 3. 保存订单</span></span><br><span class="line">        <span class="type">OrderEntity</span> <span class="variable">orderEntity</span> <span class="operator">=</span> <span class="built_in">this</span>.doSaveOrder(openid, productEntity);</span><br><span class="line">        <span class="comment">// 4. 创建支付</span></span><br><span class="line">        <span class="type">PayOrderEntity</span> <span class="variable">payOrderEntity</span> <span class="operator">=</span> <span class="built_in">this</span>.doPrepayOrder(openid, orderEntity.getOrderId(), productEntity.getProductName(), orderEntity.getTotalAmount());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> payOrderEntity;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>提交支付宝沙箱支付请求</li>
</ol>
<p>alipayClient.pageExecute(request).getBody()</p>
<p>它会返回给我们一串html代码，我们返回给前端，用户就能看到支付界面了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> PayOrderEntity <span class="title function_">doPrepayOrder</span><span class="params">(String openid, String orderId, String productName, BigDecimal amountTotal)</span> <span class="keyword">throws</span> AlipayApiException &#123;</span><br><span class="line">    <span class="type">AlipayTradePagePayRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradePagePayRequest</span>();  <span class="comment">// 发送请求的 Request类</span></span><br><span class="line">    request.setNotifyUrl(notify_url);			<span class="comment">// 支付的地址</span></span><br><span class="line">    request.setReturnUrl(return_url);</span><br><span class="line"></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">bizContent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    bizContent.put(<span class="string">&quot;out_trade_no&quot;</span>, orderId);  <span class="comment">// 我们自己生成的订单编号</span></span><br><span class="line">    bizContent.put(<span class="string">&quot;total_amount&quot;</span>, amountTotal.toString()); <span class="comment">// 订单的总金额</span></span><br><span class="line">    bizContent.put(<span class="string">&quot;subject&quot;</span>, productName);   <span class="comment">// 支付的名称</span></span><br><span class="line">    bizContent.put(<span class="string">&quot;product_code&quot;</span>, <span class="string">&quot;FAST_INSTANT_TRADE_PAY&quot;</span>);  <span class="comment">// 固定配置</span></span><br><span class="line">    request.setBizContent(bizContent.toString());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建支付单</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">codeUrl</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != alipayClient) &#123;</span><br><span class="line">        codeUrl = alipayClient.pageExecute(request).getBody();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        codeUrl = <span class="string">&quot;因你未配置支付渠道，所以暂时不能生成有效的支付URL。请配置支付渠道后，在application-dev.yml中配置支付渠道信息&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新订单支付信息</span></span><br><span class="line">    orderRepository.updateOrderPayInfo(payOrderEntity);</span><br><span class="line">    <span class="keyword">return</span> payOrderEntity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="步骤二-支付宝支付回调"><a href="#步骤二-支付宝支付回调" class="headerlink" title="步骤二 支付宝支付回调"></a>步骤二 支付宝支付回调</h2><p>拿到支付成功的回调请求，更新订单为已支付，并发送MQ消息，进行发货</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 支付宝验签</span><br><span class="line">if (checkSignature) &#123;</span><br><span class="line">    // 更新订单</span><br><span class="line">    boolean isSuccess = orderService.changeOrderPaySuccess(tradeNo, alipayTradeNo, new BigDecimal(totalAmount).divide(new BigDecimal(100), 2, RoundingMode.HALF_UP), dateFormat.parse(gmtPayment));</span><br><span class="line">    if (isSuccess) &#123;</span><br><span class="line">        eventBus.post(tradeNo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/project/openai/openai10/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/project/openai/openai10/" class="post-title-link" itemprop="url">【1开发】AI问答助手项目记录5 - 项目最终结构</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E9%A1%B9%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">项目</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E9%A1%B9%E7%9B%AE/AI%E9%97%AE%E7%AD%94%E5%8A%A9%E6%89%8B/" itemprop="url" rel="index"><span itemprop="name">AI问答助手</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="https://raw.githubusercontent.com/cccccc96/cloudimg/main/OpenAI.png" alt="OpenAI"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/project/dbrouter/dbrouter10/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/project/dbrouter/dbrouter10/" class="post-title-link" itemprop="url">【1开发】mysql动态路由组件记录2 - 简历</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E9%A1%B9%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">项目</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E9%A1%B9%E7%9B%AE/mysql%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1%E7%BB%84%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">mysql动态路由组件</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><strong>项目名称</strong>：Mysql分库分表【组件】</li>
<li><strong>核心技术</strong>：SpringBoot、SpringBoot Starter、AOP、AbstractRoutingDataSource、MyBatis Plugin StatementHandler、哈希散列、ThreadLocal</li>
<li><strong>项目描述</strong>：此组件项目是为了解决在分库分表场景下，开发一款可以应对自身业务场景多变特性，即支持个性的分库分表、只分库或者只分表以及双字段控制分库和分表，同时又能满足简单维护迭代的数据库路由组件。</li>
<li>我的职责<ul>
<li>调研平方散列、除法散列、乘法散列、哈希散列以及斐波那契散列，并结合雪崩测试，选择了一块适合数据库路由的散列算法，并做功能的开发实现。</li>
<li>引入 MyBatis Plugin 插件开发功能，对执行的 SQL 语句动态变更表信息。引入AbstractRoutingDataSource替换默认数据源，动态切换数据源实现分库功能。</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/bagu/IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/bagu/IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/" class="post-title-link" itemprop="url">【1开发】【八股】IO多路复用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E5%85%AB%E8%82%A1/" itemprop="url" rel="index"><span itemprop="name">八股</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="IO多路复用"><a href="#IO多路复用" class="headerlink" title="IO多路复用"></a>IO多路复用</h2><h3 id="TCP的最基本的Socket连接编程步骤"><a href="#TCP的最基本的Socket连接编程步骤" class="headerlink" title="TCP的最基本的Socket连接编程步骤"></a>TCP的最基本的Socket连接编程步骤</h3><ol>
<li>服务端调用Socket（）和bind（）函数<ol>
<li>为Socket绑定IP地址和端口</li>
<li>为什么绑端口：通过TCP报文中的端口号，找到应用程序</li>
<li>为什么绑IP：一台机器有多个网卡，对应多个IP地址</li>
</ol>
</li>
<li>服务端listen（）函数，进入监听状态</li>
<li>客户端调用connect（）发起连接</li>
<li>服务器内核为每个Socket维护了两个队列<ol>
<li>TCP半连接队列：还没有完成三次握手</li>
<li>TCP全连接队列：完成三次握手</li>
</ol>
</li>
<li>服务端accept（）函数，从内核获取客户端的连接</li>
</ol>
<img src="https://raw.githubusercontent.com/cccccc96/cloudimg/main/image-20240721104533722.png" alt="image-20240721104533722" style="zoom:33%;" />

<h3 id="如何服务更多用户"><a href="#如何服务更多用户" class="headerlink" title="如何服务更多用户"></a>如何服务更多用户</h3><ol>
<li>服务器单机理论多大连接多少客户端</li>
</ol>
<p>TCP连接：本机IP，本机端口，对端IP，对端端口</p>
<p>最大TCP连接数：客户端IP数客户端IP数（2 ^ 32）* 客户端端 口数（2 ^ 16 ）&#x3D;2^48</p>
<p>但注定不能这么多：文件描述符、系统内存</p>
<p>C10k，并发1万请求，从硬件角度来说，2g千兆网卡，只需要保证每条请求200kb的内存和100kb的带宽。</p>
<ol>
<li>实际不行</li>
</ol>
<p>因为上面最基本的Socket，同步阻塞，只能满足一对一通信</p>
<ul>
<li>服务端还没处理完一个客户端的IO</li>
<li>读写操作发生阻塞</li>
</ul>
<p>其他客户端都无法与服务端连接</p>
<h3 id="多线程模型"><a href="#多线程模型" class="headerlink" title="多线程模型"></a>多线程模型</h3><p>父进程只负责accept（）建立连接</p>
<p>线程池负责读写</p>
<p>C10K，代表要维护1万个线程，操作系统不可能扛得住</p>
<h3 id="IO多路复用-1"><a href="#IO多路复用-1" class="headerlink" title="IO多路复用"></a>IO多路复用</h3><p>使用一个进程来维护多个Socket，这就是I&#x2F;O多路复用。</p>
<p>我们熟悉的 select&#x2F;poll&#x2F;epoll 内核提供给用户态的多路复用系统调用</p>
<ul>
<li>进程可以通过一个系统调用函数从内核中获取多个事件。</li>
</ul>
<p>select&#x2F;poll&#x2F;epoll 是如何获取网络事件？</p>
<ul>
<li>先把所有连接传给内核，之后内核返回产生了事件的连接</li>
</ul>
<h3 id="Select-poll"><a href="#Select-poll" class="headerlink" title="Select&#x2F;poll"></a>Select&#x2F;poll</h3><ol>
<li>将已连接的Socket都放到一个文件描述符集合</li>
<li>调用Select集合拷贝到内核</li>
<li>内核检查是否有网络事件产生<ol>
<li>遍历文件描述符集合，检查到有事件发生，标记Socket可读、可写</li>
</ol>
</li>
<li>再将整个描述符集合拷贝回用户</li>
<li>用户态遍历文件描述符集合找到可读、可写的Socket，再对其处理。</li>
</ol>
<p>两次遍历，两次拷贝，文件描述符集合</p>
<p>Select、Poll区别：一个用固定长度的BitsMap；一个用动态数组，链表</p>
<p>采用线性集合存储Socket集合，时间复杂度为O（n），也需要再用户态与内核态之间拷贝文件描述集合</p>
<h3 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h3><p>epoll 通过两个方面，很好解决了 select&#x2F;poll 的问题。</p>
<ol>
<li>epoll在内核中用红黑树跟踪进程所有待检测的文件描述字。只需要传入一个待检测的socket，不用每次传入整个socket集合，避免大量拷贝</li>
<li>使用事件驱动的机制，内核里维护了一个链表记录就绪事件，每当有事件发生，通过回调函数将其加入到就绪事件列表，当用户调用 <code>epoll_wait()</code> 函数时，只会返回有事件发生的文件描述符的个数，不需要轮询扫描。</li>
</ol>
<img src="https://raw.githubusercontent.com/cccccc96/cloudimg/main/image-20240721104607391.png" alt="image-20240721104607391" style="zoom: 50%;" />

<p>边缘触发和水平触发</p>
<ul>
<li>边缘触发：当被Socket描述符上有可读事件发生，服务器端只会从epoll_wait中苏醒一次，因此一次性将内核中的数据读取完<ul>
<li>epoll</li>
<li>边缘触发模式一般和非阻塞 I&#x2F;O 搭配使用</li>
<li>边缘触发的效率比水平触发的效率要高，减少 epoll_wait</li>
</ul>
</li>
<li>水平触发：当被监控的 Socket 上有可读事件发生时，服务器端不断地从 epoll_wait 中苏醒，直到内核缓冲区数据被 read 函数读完才结束<ul>
<li>select、poll、epoll默认</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/bagu/JWT%E8%BF%98%E6%98%AFcookie/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/bagu/JWT%E8%BF%98%E6%98%AFcookie/" class="post-title-link" itemprop="url">【1开发】【八股】JWT</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E5%85%AB%E8%82%A1/" itemprop="url" rel="index"><span itemprop="name">八股</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h2><h4 id="1-无状态"><a href="#1-无状态" class="headerlink" title="1 无状态"></a>1 无状态</h4><p>简化验证流程，JWT自身包含了身份验证所需要的所有信息（用户身份，有效期），服务器端不需要存储Session信息，大大减轻了服务器端的压力</p>
<h4 id="2-有效避免CSRF（跨站请求伪造）"><a href="#2-有效避免CSRF（跨站请求伪造）" class="headerlink" title="2 有效避免CSRF（跨站请求伪造）"></a>2 有效避免CSRF（跨站请求伪造）</h4><p>某个链接中藏了一个请求，那么只要发出请求，cookie就会被携带，借助这个特性</p>
<h4 id="3-移动端应用"><a href="#3-移动端应用" class="headerlink" title="3 移动端应用"></a>3 移动端应用</h4><p>移动端应用管理和维护Cookie比较复杂</p>
<h4 id="4-单点登录友好"><a href="#4-单点登录友好" class="headerlink" title="4 单点登录友好"></a>4 单点登录友好</h4><p>需要常见的cookie跨域问题</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><h4 id="注销登录"><a href="#注销登录" class="headerlink" title="注销登录"></a>注销登录</h4><p>无法注销，通过Redis存储</p>
<h4 id="续签问题"><a href="#续签问题" class="headerlink" title="续签问题"></a>续签问题</h4><p>无法动态刷新</p>
<ul>
<li>每次进行校验时，重新生成JWT返回给客户端</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/bagu/redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/bagu/redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" class="post-title-link" itemprop="url">【1开发】【八股】Redis分布式锁</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E5%85%AB%E8%82%A1/" itemprop="url" rel="index"><span itemprop="name">八股</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Redis分布式锁"><a href="#Redis分布式锁" class="headerlink" title="Redis分布式锁"></a>Redis分布式锁</h1><p>Redis是基于内存操作，性能极高。</p>
<p>考虑如果没有reddsion，用setIfAbsent</p>
<h4 id="方案1-（直接加锁）"><a href="#方案1-（直接加锁）" class="headerlink" title="方案1 （直接加锁）"></a>方案1 （直接加锁）</h4><p>如果缓存里没有数据，就加锁。加锁成功就访问，反之就自旋重新拿数据。</p>
<p>缺点：虽然设置了<strong>过期时间</strong>，但当业务执行完成之后，我们的锁还持有着。我们<strong>希望的是业务执行完之后，立即释放锁</strong>。</p>
<h4 id="方案2（finally删除锁）"><a href="#方案2（finally删除锁）" class="headerlink" title="方案2（finally删除锁）"></a>方案2（finally删除锁）</h4><p>在方案1的基础之上，加一行finally删除锁。</p>
<p>缺点：假如过期时间比较短，B已经获取了锁，那么<strong>A执行完之后可能会释放B的锁</strong></p>
<h4 id="方案3（锁设置一个value值）"><a href="#方案3（锁设置一个value值）" class="headerlink" title="方案3（锁设置一个value值）"></a>方案3（锁设置一个value值）</h4><p>在方案2的情况下，加锁的时候，设置一个value值。</p>
<p>缺点：如何设置过期时间值</p>
<ul>
<li>太短：业务还没有执行完，就执行完了</li>
<li>太长：节点宕机了， 其他节点一直获取不到锁</li>
</ul>
<p><strong>看门狗</strong>：<strong>守护线程</strong>，隔固定时间去查看业务是否执行完毕，如果没有就<strong>续期</strong>。</p>
<h4 id="方案4（Reddision-trylock）"><a href="#方案4（Reddision-trylock）" class="headerlink" title="方案4（Reddision trylock）"></a>方案4（Reddision trylock）</h4><p>解决了前三个方案的问题：</p>
<ul>
<li>锁过期问题，释放他人的锁</li>
<li>看门狗机制：默认锁过期时间是30s，会有一个定时任务在每10s去扫描一下该锁是否被释放，如果没有释放就延长至30s</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/bagu/springAOP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/bagu/springAOP/" class="post-title-link" itemprop="url">【1开发】【八股】springAOP</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E5%85%AB%E8%82%A1/" itemprop="url" rel="index"><span itemprop="name">八股</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="什么是AOP"><a href="#什么是AOP" class="headerlink" title="什么是AOP"></a>什么是AOP</h2><p>AOP（Aspect Oriented Programming）即面向切面编程。将把一些业务逻辑中的相同代码从核心业务逻辑中分离出来。</p>
<p>如何实现呢？</p>
<ul>
<li>Aspect（切面）：</li>
<li>Join Point（连接点）：被拦截到的方法</li>
<li>PointCut（切点）：定位</li>
<li>Advice（通知）：Before&#x2F;Around&#x2F;After</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span> 切面</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DBRouterJoinPoint</span> &#123;</span><br><span class="line">		<span class="comment">// Pointcut 切点，定位</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;@annotation(cn.bugstack.middleware.db.router.annotation.DBRouter)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">aopPoint</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Around 通知，环绕</span></span><br><span class="line">    <span class="meta">@Around(&quot;aopPoint() &amp;&amp; @annotation(dbRouter)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">doRouter</span><span class="params">(ProceedingJoinPoint jp, DBRouter dbRouter)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        .......</span><br><span class="line">        <span class="type">String</span> <span class="variable">dbKeyAttr</span> <span class="operator">=</span> getAttrValue(dbKey, jp.getArgs());</span><br><span class="line">        dbRouterStrategy.doRouter(dbKeyAttr);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> jp.proceed();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           dbRouterStrategy.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="怎么实现的-–-动态代理"><a href="#怎么实现的-–-动态代理" class="headerlink" title="怎么实现的 – 动态代理"></a>怎么实现的 – 动态代理</h3><p>啥是代理，以静态代理说明：代理类和目标类实现相同的接口，然后代理类里面维护一个目标类就完事了。</p>
<p>那么spring AOP中的动态代理包含两类：默认如果使用接口的，用 JDK 提供的动态代理实现，如果是方法则使用 CGLIB 实现</p>
<h4 id="1-JDK动态代理（缺点，只能代理接口）"><a href="#1-JDK动态代理（缺点，只能代理接口）" class="headerlink" title="1. JDK动态代理（缺点，只能代理接口）"></a>1. JDK动态代理（缺点，只能代理接口）</h4><p>通过java.lang.reflect.Proxy来实现（反射）</p>
<ul>
<li>InvocationHandler + invoke</li>
</ul>
<p>所以，AOP创建一个代理对象，在方法调用前后插入横切逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Service</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">perform</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">Service</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">perform</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Performing service...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceInvocationHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Object target;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceInvocationHandler</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Before method&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> method.invoke(target, args);</span><br><span class="line">        System.out.println(<span class="string">&quot;After method&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Service</span> <span class="variable">service</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServiceImpl</span>();</span><br><span class="line">        <span class="type">Service</span> <span class="variable">proxy</span> <span class="operator">=</span> (Service) Proxy.newProxyInstance(</span><br><span class="line">            service.getClass().getClassLoader(),</span><br><span class="line">            service.getClass().getInterfaces(),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ServiceInvocationHandler</span>(service)</span><br><span class="line">        );</span><br><span class="line">        proxy.perform();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="2-CGLIB-动态代理（可以代理类）"><a href="#2-CGLIB-动态代理（可以代理类）" class="headerlink" title="2. CGLIB 动态代理（可以代理类）"></a>2. CGLIB 动态代理（可以代理类）</h4><p>基于ASM操作字节码。需要cglib库,MethodInterceptor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProxyFactory</span> <span class="keyword">implements</span> <span class="title class_">MethodInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//维护一个目标对象</span></span><br><span class="line">    <span class="keyword">private</span> Object target;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ProxyFactory</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//为目标对象生成代理对象</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getProxyInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//工具类</span></span><br><span class="line">        <span class="type">Enhancer</span> <span class="variable">en</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Enhancer</span>();</span><br><span class="line">        <span class="comment">//设置父类</span></span><br><span class="line">        en.setSuperclass(target.getClass());</span><br><span class="line">        <span class="comment">//设置回调函数</span></span><br><span class="line">        en.setCallback(<span class="built_in">this</span>);</span><br><span class="line">        <span class="comment">//创建子类对象代理</span></span><br><span class="line">        <span class="keyword">return</span> en.create();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Object obj, Method method, Object[] args, MethodProxy proxy)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;请问有什么可以帮到您？&quot;</span>);</span><br><span class="line">        <span class="comment">// 执行目标对象的方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">returnValue</span> <span class="operator">=</span> method.invoke(target, args);</span><br><span class="line">        System.out.println(<span class="string">&quot;问题已经解决啦！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="SpringAOP和AspectJ啥区别"><a href="#SpringAOP和AspectJ啥区别" class="headerlink" title="SpringAOP和AspectJ啥区别"></a>SpringAOP和AspectJ啥区别</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2022 - 2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">蔡正海</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  



  <script src="/js/third-party/fancybox.js"></script>



  





</body>
</html>
