<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":true,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="czh的学习小站">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="czh的学习小站">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="蔡正海">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>czh的学习小站</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">czh的学习小站</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">自律</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="蔡正海"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">蔡正海</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">46</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/project/openai/openai1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/project/openai/openai1/" class="post-title-link" itemprop="url">【1开发】AI问答助手项目记录1 - 用户登陆鉴权</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E9%A1%B9%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">项目</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E9%A1%B9%E7%9B%AE/AI%E9%97%AE%E7%AD%94%E5%8A%A9%E6%89%8B/" itemprop="url" rel="index"><span itemprop="name">AI问答助手</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="整体结构引言"><a href="#整体结构引言" class="headerlink" title="整体结构引言"></a>整体结构引言</h2><p>目前的大模型不管是chatgpt，还是国内的类似kimi都需要开发一个系统界面，便于用户的使用。</p>
<p>AI问答助手应该实现两个核心逻辑：一个是各类大模型的对接；一个是用户的聊天系统，包含用户登陆、鉴权。</p>
<h2 id="用户登陆鉴权"><a href="#用户登陆鉴权" class="headerlink" title="用户登陆鉴权"></a>用户登陆鉴权</h2><p>我们先处理第一步，用户如何进行登陆鉴权。我们选择通过微信公众号验证码的方式登陆。</p>
<h3 id="第一步，公众号接入"><a href="#第一步，公众号接入" class="headerlink" title="第一步，公众号接入"></a>第一步，公众号接入</h3><p>要用公众号验证码的方式登陆，我们首先得从公众号拿到验证码。公众号的配置和实现还是比较固定的：验签和请求应答。（当然，别忘了在公众号官网的配置页面里把请求地址设置好）</p>
<h4 id="验签"><a href="#验签" class="headerlink" title="验签"></a>验签</h4><p>这个流程是固定的，网上直接找份代码就行。其实就是</p>
<ol>
<li>公众号端传来的参数：时间戳、随机数、签名。</li>
<li>将时间戳、随机数、和本机保存的token一起做一个SHA-1</li>
<li>最后和签名比较</li>
</ol>
<img src="https://raw.githubusercontent.com/cccccc96/cloudimg/main/image-20240703233559214.png" alt="image-20240703233559214" style="zoom:50%;" />

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(produces = &quot;text/plain;charset=utf-8&quot;)</span><br><span class="line">public String validate(@PathVariable String appid,</span><br><span class="line">                       @RequestParam(value = &quot;signature&quot;, required = false) String signature,</span><br><span class="line">                       @RequestParam(value = &quot;timestamp&quot;, required = false) String timestamp,</span><br><span class="line">                       @RequestParam(value = &quot;nonce&quot;, required = false) String nonce,</span><br><span class="line">                       @RequestParam(value = &quot;echostr&quot;, required = false) String echostr) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        log.info(&quot;微信公众号验签信息&#123;&#125;开始 [&#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;]&quot;, appid, signature, timestamp, nonce, echostr);</span><br><span class="line">        if (StringUtils.isAnyBlank(signature, timestamp, nonce, echostr)) &#123;</span><br><span class="line">            throw new IllegalArgumentException(&quot;请求参数非法，请核实!&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        boolean check = weiXinValidateService.checkSign(signature, timestamp, nonce);</span><br><span class="line">        log.info(&quot;微信公众号验签信息&#123;&#125;完成 check：&#123;&#125;&quot;, appid, check);</span><br><span class="line">        if (!check) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        return echostr;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        log.error(&quot;微信公众号验签信息&#123;&#125;失败 [&#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;]&quot;, appid, signature, timestamp, nonce, echostr, e);</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="消息请求（处理验证码）"><a href="#消息请求（处理验证码）" class="headerlink" title="消息请求（处理验证码）"></a>消息请求（处理验证码）</h4><p>用户发一个消息，我们要生成一个随机数（验证码）返回给用户的同时，保存进Redis。用于后续用户在网页端输入验证码，我们要进行确认，验证码是否有效。</p>
<p>当我们接收到公众号发来的请求</p>
<ul>
<li>生成验证码</li>
<li>openid和验证码 进行缓存</li>
<li>返回给公众号验证码</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生成验证码</span></span><br><span class="line"><span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> repository.genCode(userBehaviorMessageEntity.getOpenId());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 反馈信息[文本]</span></span><br><span class="line"><span class="type">MessageTextEntity</span> <span class="variable">res</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageTextEntity</span>();</span><br><span class="line">res.setToUserName(userBehaviorMessageEntity.getOpenId());</span><br><span class="line">res.setFromUserName(originalId);</span><br><span class="line">res.setCreateTime(String.valueOf(System.currentTimeMillis() / <span class="number">1000L</span>));</span><br><span class="line">res.setMsgType(<span class="string">&quot;text&quot;</span>);</span><br><span class="line">res.setContent(String.format(<span class="string">&quot;您的验证码为：%s 有效期%d分钟！&quot;</span>, code, <span class="number">3</span>));</span><br><span class="line"><span class="keyword">return</span> XmlUtil.beanToXml(res);</span><br></pre></td></tr></table></figure>

<p>（验证码防重）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">public String genCode(String openId) &#123;</span><br><span class="line">        // 获取值</span><br><span class="line">        String isExitCode = redisService.getValue(Key + &quot;_&quot; + openId);</span><br><span class="line">        if (StringUtils.isNotBlank(isExitCode)) return isExitCode;</span><br><span class="line">        // 生成值</span><br><span class="line">        RLock lock = redisService.getLock(Key);</span><br><span class="line">        try &#123;</span><br><span class="line">            lock.lock(15, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">            String code = RandomStringUtils.randomNumeric(4);</span><br><span class="line">            // 防重校验&amp;重新生成</span><br><span class="line">            for (int i = 0; i &lt; 10 &amp;&amp; StringUtils.isNotBlank(redisService.getValue(Key + &quot;_&quot; + code)); i++) &#123;</span><br><span class="line">                if (i &lt; 3) &#123;</span><br><span class="line">                    code = RandomStringUtils.randomNumeric(4);</span><br><span class="line">                &#125; else if (i &lt; 5) &#123;</span><br><span class="line">                    code = RandomStringUtils.randomNumeric(5);</span><br><span class="line">                &#125; else if (i &lt; 9) &#123;</span><br><span class="line">                    code = RandomStringUtils.randomNumeric(6);</span><br><span class="line">                    log.warn(&quot;验证码重复，生成6位字符串验证码 &#123;&#125; &#123;&#125;&quot;, openId, code);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    return &quot;您的验证码获取失败，请重新回复405获取。&quot;;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // 存储值【3分钟有效期】</span><br><span class="line">            redisService.setValue(Key + &quot;_&quot; + code, openId, 3 * 60 * 1000);</span><br><span class="line">            redisService.setValue(Key + &quot;_&quot; + openId, code);</span><br><span class="line"></span><br><span class="line">            return code;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="第二步，用户拿到验证码后输入"><a href="#第二步，用户拿到验证码后输入" class="headerlink" title="第二步，用户拿到验证码后输入"></a>第二步，用户拿到验证码后输入</h2><p>用户输入验证码，点击确认，发送一个auth请求，我们拿到请求后，就可以根据验证码进行确认。</p>
<ul>
<li>检查验证码（是否在缓存中）</li>
<li>jwt生成token并返回（根据openid生成token）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> AuthStateEntity <span class="title function_">doLogin</span><span class="params">(String code)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 校验判断，非成功则直接返回</span></span><br><span class="line">    <span class="type">AuthStateEntity</span> <span class="variable">authStateEntity</span> <span class="operator">=</span> <span class="built_in">this</span>.checkCode(code);</span><br><span class="line">    <span class="keyword">if</span> (!authStateEntity.getCode().equals(AuthTypeVO.A0000.getCode())) &#123;</span><br><span class="line">        <span class="keyword">return</span> authStateEntity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 获取 Token 并返回</span></span><br><span class="line">    Map&lt;String, Object&gt; chaim = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    chaim.put(<span class="string">&quot;openId&quot;</span>, authStateEntity.getOpenId());</span><br><span class="line">    <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> encode(authStateEntity.getOpenId(), <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>, chaim);</span><br><span class="line">    authStateEntity.setToken(token);</span><br><span class="line">    log.info(<span class="string">&quot;encode token : &#123;&#125;&quot;</span>,token);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> authStateEntity;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>验证码去缓存中确认</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> AuthStateEntity <span class="title function_">checkCode</span><span class="params">(String code)</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;codeCache ： &#123;&#125;&quot;</span>, JSON.toJSONString(codeCache.asMap()));</span><br><span class="line">    <span class="comment">// 获取验证码校验</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">openId</span> <span class="operator">=</span> codeCache.getIfPresent(code);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(openId))&#123;</span><br><span class="line">        log.info(<span class="string">&quot;鉴权，用户输入的验证码不存在 &#123;&#125;&quot;</span>, code);</span><br><span class="line">        <span class="keyword">return</span> AuthStateEntity.builder()</span><br><span class="line">                .code(AuthTypeVO.A0001.getCode())</span><br><span class="line">                .info(AuthTypeVO.A0001.getInfo())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">// 移除缓存Key值</span></span><br><span class="line">    codeCache.invalidate(openId);</span><br><span class="line">    codeCache.invalidate(code);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证码校验成功</span></span><br><span class="line">    <span class="keyword">return</span> AuthStateEntity.builder()</span><br><span class="line">            .code(AuthTypeVO.A0000.getCode())</span><br><span class="line">            .info(AuthTypeVO.A0000.getInfo())</span><br><span class="line">            .openId(openId)</span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>jwt 编码（用openid进行编码）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 这里就是产生jwt字符串的地方</span></span><br><span class="line"><span class="comment"> * jwt字符串包括三个部分</span></span><br><span class="line"><span class="comment"> * 1. header</span></span><br><span class="line"><span class="comment"> * -当前字符串的类型，一般都是“JWT”</span></span><br><span class="line"><span class="comment"> * -哪种算法加密，“HS256”或者其他的加密算法</span></span><br><span class="line"><span class="comment"> * 所以一般都是固定的，没有什么变化</span></span><br><span class="line"><span class="comment"> * 2. payload</span></span><br><span class="line"><span class="comment"> * 一般有四个最常见的标准字段（下面有）</span></span><br><span class="line"><span class="comment"> * iat：签发时间，也就是这个jwt什么时候生成的</span></span><br><span class="line"><span class="comment"> * jti：JWT的唯一标识</span></span><br><span class="line"><span class="comment"> * iss：签发人，一般都是username或者userId</span></span><br><span class="line"><span class="comment"> * exp：过期时间</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> String <span class="title function_">encode</span><span class="params">(String issuer, <span class="type">long</span> ttlMillis, Map&lt;String, Object&gt; claims)</span> &#123;</span><br><span class="line">    <span class="comment">// iss签发人，ttlMillis生存时间，claims是指还想要在jwt中存储的一些非隐私信息</span></span><br><span class="line">    <span class="keyword">if</span> (claims == <span class="literal">null</span>) &#123;</span><br><span class="line">        claims = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="variable">nowMillis</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    <span class="type">JwtBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> Jwts.builder()</span><br><span class="line">            <span class="comment">// 荷载部分</span></span><br><span class="line">            .setClaims(claims)</span><br><span class="line">            <span class="comment">// 这个是JWT的唯一标识，一般设置成唯一的，这个方法可以生成唯一标识</span></span><br><span class="line">            .setId(UUID.randomUUID().toString())<span class="comment">//2.</span></span><br><span class="line">            <span class="comment">// 签发时间</span></span><br><span class="line">            .setIssuedAt(<span class="keyword">new</span> <span class="title class_">Date</span>(nowMillis))</span><br><span class="line">            <span class="comment">// 签发人，也就是JWT是给谁的（逻辑上一般都是username或者userId）</span></span><br><span class="line">            .setSubject(issuer)</span><br><span class="line">            .signWith(SignatureAlgorithm.HS256, base64EncodedSecretKey);<span class="comment">//这个地方是生成jwt使用的算法和秘钥</span></span><br><span class="line">    <span class="keyword">if</span> (ttlMillis &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">expMillis</span> <span class="operator">=</span> nowMillis + ttlMillis;</span><br><span class="line">        <span class="type">Date</span> <span class="variable">exp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>(expMillis);<span class="comment">// 4. 过期时间，这个也是使用毫秒生成的，使用当前时间+前面传入的持续时间生成</span></span><br><span class="line">        builder.setExpiration(exp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> builder.compact();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Token和cookie的区别（待看）"><a href="#Token和cookie的区别（待看）" class="headerlink" title="Token和cookie的区别（待看）"></a>Token和cookie的区别（待看）</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/project/openai/openai2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/project/openai/openai2/" class="post-title-link" itemprop="url">【1开发】AI问答助手项目记录2 - 大模型api</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E9%A1%B9%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">项目</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E9%A1%B9%E7%9B%AE/AI%E9%97%AE%E7%AD%94%E5%8A%A9%E6%89%8B/" itemprop="url" rel="index"><span itemprop="name">AI问答助手</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="通过okhttp为大模型自己实现一个api"><a href="#通过okhttp为大模型自己实现一个api" class="headerlink" title="通过okhttp为大模型自己实现一个api"></a>通过okhttp为大模型自己实现一个api</h2><p>涉及到的技术栈：okhttp3、Jackson</p>
<img src="https://raw.githubusercontent.com/cccccc96/cloudimg/main/image-20240704115618698.png" alt="image-20240704115618698" style="zoom: 50%;" />

<h2 id="chatglm请求里的几个核心字段"><a href="#chatglm请求里的几个核心字段" class="headerlink" title="chatglm请求里的几个核心字段"></a>chatglm请求里的几个核心字段</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 模型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">Model</span> <span class="variable">model</span> <span class="operator">=</span> Model.GLM_3_5_TURBO;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 请求参数 &#123;&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;你好&quot;&#125;</span></span><br><span class="line"><span class="comment"> * 24年1月发布的 GLM_3_5_TURBO、GLM_4 模型时新增</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> List&lt;Prompt&gt; messages;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 请求ID</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@JsonProperty(&quot;request_id&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">requestId</span> <span class="operator">=</span> String.format(<span class="string">&quot;czh-%d&quot;</span>, System.currentTimeMillis());</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * do_sample 为 true 时启用采样策略，do_sample 为 false 时采样策略 temperature、top_p 将不生效</span></span><br><span class="line"><span class="comment"> * 24年1月发布的 GLM_3_5_TURBO、GLM_4 模型时新增</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@JsonProperty(&quot;do_sample&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">Boolean</span> <span class="variable">doSample</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用同步调用时，此参数应当设置为 Fasle 或者省略。表示模型生成完所有内容后一次性返回所有内容。</span></span><br><span class="line"><span class="comment"> * 如果设置为 True，模型将通过标准 Event Stream ，逐块返回模型生成内容。Event Stream 结束时会返回一条data: [DONE]消息。</span></span><br><span class="line"><span class="comment"> * 24年1月发布的 GLM_3_5_TURBO、GLM_4 模型时新增</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">Boolean</span> <span class="variable">stream</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>



<h2 id="整体结构"><a href="#整体结构" class="headerlink" title="整体结构"></a>整体结构</h2><p>本质上，我们要开启一个openai会话，需要做以下几件事</p>
<ol>
<li>开启一个OkHttpClient<ol>
<li>设置拦截器（因为要写入大模型token）</li>
</ol>
</li>
<li>通过Retrofit封装OkHttp（方便测试）</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 开启 Http 客户端</span></span><br><span class="line"><span class="type">OkHttpClient</span> <span class="variable">okHttpClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span></span><br><span class="line">        .Builder()</span><br><span class="line">        .addInterceptor(httpLoggingInterceptor)</span><br><span class="line">        .addInterceptor(<span class="keyword">new</span> <span class="title class_">OpenAiHTTPInterceptor</span>(configuration))</span><br><span class="line">        .connectTimeout(configuration.getConnectTimeout(), TimeUnit.SECONDS)</span><br><span class="line">        .writeTimeout(configuration.getWriteTimeout(), TimeUnit.SECONDS)</span><br><span class="line">        .readTimeout(configuration.getReadTimeout(), TimeUnit.SECONDS)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">configuration.setOkHttpClient(okHttpClient);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 创建 API 服务</span></span><br><span class="line"><span class="type">IOpenAiApi</span> <span class="variable">openAiApi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Retrofit</span>.Builder()</span><br><span class="line">        .baseUrl(configuration.getApiHost())</span><br><span class="line">        .client(okHttpClient)</span><br><span class="line">        .addCallAdapterFactory(RxJava2CallAdapterFactory.create())</span><br><span class="line">        .addConverterFactory(JacksonConverterFactory.create())</span><br><span class="line">        .build().create(IOpenAiApi.class);</span><br><span class="line"></span><br><span class="line">configuration.setOpenAiApi(openAiApi);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 实例化执行器</span></span><br><span class="line">HashMap&lt;Model, Executor&gt; executorGroup = configuration.newExecutorGroup();</span><br></pre></td></tr></table></figure>

<h2 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h2><p>实现okhttp3.Interceptor的拦截器。</p>
<p>在用户调用sdk时拦截，并传入用户自定义的apikey</p>
<p>也就是加上Authorization字段，这也是大模型通用的做法（对于这里的chatglm而言，我们还需要对apikey进行jwt编码）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@NotNull</span> Response <span class="title function_">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 1. 获取原始 Request</span></span><br><span class="line">        <span class="type">Request</span> <span class="variable">original</span> <span class="operator">=</span> chain.request();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 构建请求</span></span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> original.newBuilder()</span><br><span class="line">                .url(original.url())</span><br><span class="line">                .header(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;Bearer &quot;</span> + BearerTokenUtils.getToken(configuration.getApiKey(), configuration.getApiSecret()))</span><br><span class="line">                .header(<span class="string">&quot;Content-Type&quot;</span>, Configuration.JSON_CONTENT_TYPE)</span><br><span class="line">                .header(<span class="string">&quot;User-Agent&quot;</span>, Configuration.DEFAULT_USER_AGENT)</span><br><span class="line"><span class="comment">//                .header(&quot;Accept&quot;, null != original.header(&quot;Accept&quot;) ? original.header(&quot;Accept&quot;) : Configuration.SSE_CONTENT_TYPE)</span></span><br><span class="line">                .method(original.method(), original.body())</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 返回执行结果</span></span><br><span class="line">        <span class="keyword">return</span> chain.proceed(request);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="会话接口-基于eventsource的响应"><a href="#会话接口-基于eventsource的响应" class="headerlink" title="会话接口 - 基于eventsource的响应"></a>会话接口 - 基于eventsource的响应</h2><p>使用eventsource进行流式传输，适用于长时间连接并接收实时更新的情况，接受一个请求对象和事件监听器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> EventSource.Factory factory;</span><br><span class="line"><span class="keyword">public</span> EventSource <span class="title function_">completions</span><span class="params">(ChatCompletionRequest chatCompletionRequest, EventSourceListener eventSourceListener)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 构建请求信息</span></span><br><span class="line">    <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">            .url(configuration.getApiHost().concat(IOpenAiApi.v4))</span><br><span class="line">            .post(RequestBody.create(MediaType.parse(Configuration.JSON_CONTENT_TYPE), chatCompletionRequest.toString()))</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回事件结果</span></span><br><span class="line">    <span class="keyword">return</span> factory.newEventSource(request, chatCompletionRequest.getIsCompatible() ? eventSourceListener(eventSourceListener) : eventSourceListener);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">openAiSession.completions(request, <span class="keyword">new</span> <span class="title class_">EventSourceListener</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onEvent</span><span class="params">(EventSource eventSource, <span class="meta">@Nullable</span> String id, <span class="meta">@Nullable</span> String type, String data)</span> &#123;</span><br><span class="line">                <span class="type">ChatCompletionResponse</span> <span class="variable">response</span> <span class="operator">=</span> JSON.parseObject(data, ChatCompletionResponse.class);</span><br><span class="line">                log.info(<span class="string">&quot;测试结果 onEvent czh：&#123;&#125;&quot;</span>, type);</span><br><span class="line">                log.info(<span class="string">&quot;测试结果 onEvent：&#123;&#125;&quot;</span>, response.getData());</span><br><span class="line">                <span class="comment">// type 消息类型，add 增量，finish 结束，error 错误，interrupted 中断</span></span><br><span class="line">                <span class="keyword">if</span> (EventType.finish.getCode().equals(type)) &#123;</span><br><span class="line">                    ChatCompletionResponse.<span class="type">Meta</span> <span class="variable">meta</span> <span class="operator">=</span> JSON.parseObject(response.getMeta(), ChatCompletionResponse.Meta.class);</span><br><span class="line">                    log.info(<span class="string">&quot;[输出结束] Tokens &#123;&#125;&quot;</span>, JSON.toJSONString(meta));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClosed</span><span class="params">(EventSource eventSource)</span> &#123;</span><br><span class="line">                log.info(<span class="string">&quot;对话完成&quot;</span>);</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(EventSource eventSource, <span class="meta">@Nullable</span> Throwable t, <span class="meta">@Nullable</span> Response response)</span> &#123;</span><br><span class="line">                log.info(<span class="string">&quot;对话异常&quot;</span>);</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/project/openai/openai3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/project/openai/openai3/" class="post-title-link" itemprop="url">【1开发】AI问答助手项目记录3 - 规则过滤</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E9%A1%B9%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">项目</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E9%A1%B9%E7%9B%AE/AI%E9%97%AE%E7%AD%94%E5%8A%A9%E6%89%8B/" itemprop="url" rel="index"><span itemprop="name">AI问答助手</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="规则过滤"><a href="#规则过滤" class="headerlink" title="规则过滤"></a>规则过滤</h2><p>用户在真正调用大模型前，我们需要进行规则过滤，只有满足所有规则，才能真正请求大模型。</p>
<p>规则：敏感词、白名单、频次限制、账户状态、账户额度</p>
<p>这里的实现和抽奖项目一样，采用责任链，为每个规则定义一个过滤实现。</p>
<p>特别地，对于敏感词，我们用hubbo提供的敏感词包进行过滤</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">List&lt;MessageEntity&gt; newMessages = chatProcess.getMessages().stream()</span><br><span class="line">        .map(message -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> message.getContent();</span><br><span class="line">            <span class="type">String</span> <span class="variable">replace</span> <span class="operator">=</span> words.replace(content);</span><br><span class="line">            <span class="keyword">return</span> MessageEntity.builder()</span><br><span class="line">                    .role(message.getRole())</span><br><span class="line">                    .name(message.getName())</span><br><span class="line">                    .content(replace)</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;)</span><br><span class="line">        .collect(Collectors.toList());</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/project/openai/openai4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/project/openai/openai4/" class="post-title-link" itemprop="url">【1开发】AI问答助手项目记录4 - 商品下单</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E9%A1%B9%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">项目</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E9%A1%B9%E7%9B%AE/AI%E9%97%AE%E7%AD%94%E5%8A%A9%E6%89%8B/" itemprop="url" rel="index"><span itemprop="name">AI问答助手</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="商品下单"><a href="#商品下单" class="headerlink" title="商品下单"></a>商品下单</h2><p>这里的商品就是各种大模型次数的额度</p>
<h2 id="步骤1-用户点击购买，创建未支付订单，等待用户支付"><a href="#步骤1-用户点击购买，创建未支付订单，等待用户支付" class="headerlink" title="步骤1 用户点击购买，创建未支付订单，等待用户支付"></a>步骤1 用户点击购买，创建未支付订单，等待用户支付</h2><p>我们主要做两件事：创建订单，请求支付宝支付请求</p>
<ol>
<li>校验token，获取用户id和商品信息，根据用户信息和商品信息创建未支付订单</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;create_pay_order&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="keyword">public</span> Response&lt;String&gt; <span class="title function_">createParOrder</span><span class="params">(<span class="meta">@RequestHeader(&quot;Authorization&quot;)</span> String token, <span class="meta">@RequestParam</span> Integer productId)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. Token 校验</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. Token 解析</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ShopCartEntity</span> <span class="variable">shopCartEntity</span> <span class="operator">=</span> ShopCartEntity.builder()</span><br><span class="line">                .openid(openid)</span><br><span class="line">                .productId(productId).build();</span><br><span class="line"></span><br><span class="line">        <span class="type">PayOrderEntity</span> <span class="variable">payOrder</span> <span class="operator">=</span> orderService.createOrder(shopCartEntity);</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>如果用户存在有效的未支付订单，则直接返回原来的那笔订单；否则的话，创建一笔未支付订单</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> PayOrderEntity <span class="title function_">createOrder</span><span class="params">(ShopCartEntity shopCartEntity)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 0. 基础信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">openid</span> <span class="operator">=</span> shopCartEntity.getOpenid();</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">productId</span> <span class="operator">=</span> shopCartEntity.getProductId();</span><br><span class="line">        <span class="comment">// 1. 查询有效的未支付订单，如果存在直接返回现成的</span></span><br><span class="line">        <span class="comment">// 2. 商品查询</span></span><br><span class="line">        <span class="comment">// 3. 保存订单</span></span><br><span class="line">        <span class="type">OrderEntity</span> <span class="variable">orderEntity</span> <span class="operator">=</span> <span class="built_in">this</span>.doSaveOrder(openid, productEntity);</span><br><span class="line">        <span class="comment">// 4. 创建支付</span></span><br><span class="line">        <span class="type">PayOrderEntity</span> <span class="variable">payOrderEntity</span> <span class="operator">=</span> <span class="built_in">this</span>.doPrepayOrder(openid, orderEntity.getOrderId(), productEntity.getProductName(), orderEntity.getTotalAmount());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> payOrderEntity;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>提交支付宝沙箱支付请求</li>
</ol>
<p>alipayClient.pageExecute(request).getBody()</p>
<p>它会返回给我们一串html代码，我们返回给前端，用户就能看到支付界面了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> PayOrderEntity <span class="title function_">doPrepayOrder</span><span class="params">(String openid, String orderId, String productName, BigDecimal amountTotal)</span> <span class="keyword">throws</span> AlipayApiException &#123;</span><br><span class="line">    <span class="type">AlipayTradePagePayRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradePagePayRequest</span>();  <span class="comment">// 发送请求的 Request类</span></span><br><span class="line">    request.setNotifyUrl(notify_url);			<span class="comment">// 支付的地址</span></span><br><span class="line">    request.setReturnUrl(return_url);</span><br><span class="line"></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">bizContent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    bizContent.put(<span class="string">&quot;out_trade_no&quot;</span>, orderId);  <span class="comment">// 我们自己生成的订单编号</span></span><br><span class="line">    bizContent.put(<span class="string">&quot;total_amount&quot;</span>, amountTotal.toString()); <span class="comment">// 订单的总金额</span></span><br><span class="line">    bizContent.put(<span class="string">&quot;subject&quot;</span>, productName);   <span class="comment">// 支付的名称</span></span><br><span class="line">    bizContent.put(<span class="string">&quot;product_code&quot;</span>, <span class="string">&quot;FAST_INSTANT_TRADE_PAY&quot;</span>);  <span class="comment">// 固定配置</span></span><br><span class="line">    request.setBizContent(bizContent.toString());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建支付单</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">codeUrl</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != alipayClient) &#123;</span><br><span class="line">        codeUrl = alipayClient.pageExecute(request).getBody();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        codeUrl = <span class="string">&quot;因你未配置支付渠道，所以暂时不能生成有效的支付URL。请配置支付渠道后，在application-dev.yml中配置支付渠道信息&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新订单支付信息</span></span><br><span class="line">    orderRepository.updateOrderPayInfo(payOrderEntity);</span><br><span class="line">    <span class="keyword">return</span> payOrderEntity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="步骤二-支付宝支付回调"><a href="#步骤二-支付宝支付回调" class="headerlink" title="步骤二 支付宝支付回调"></a>步骤二 支付宝支付回调</h2><p>拿到支付成功的回调请求，更新订单为已支付，并发送MQ消息，进行发货</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 支付宝验签</span><br><span class="line">if (checkSignature) &#123;</span><br><span class="line">    // 更新订单</span><br><span class="line">    boolean isSuccess = orderService.changeOrderPaySuccess(tradeNo, alipayTradeNo, new BigDecimal(totalAmount).divide(new BigDecimal(100), 2, RoundingMode.HALF_UP), dateFormat.parse(gmtPayment));</span><br><span class="line">    if (isSuccess) &#123;</span><br><span class="line">        eventBus.post(tradeNo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/project/openai/openai10/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/project/openai/openai10/" class="post-title-link" itemprop="url">【1开发】AI问答助手项目记录5 - 项目最终结构图</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E9%A1%B9%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">项目</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E9%A1%B9%E7%9B%AE/AI%E9%97%AE%E7%AD%94%E5%8A%A9%E6%89%8B/" itemprop="url" rel="index"><span itemprop="name">AI问答助手</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="https://raw.githubusercontent.com/cccccc96/cloudimg/main/OpenAI.png" alt="OpenAI"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/mybatis%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/mybatis1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/mybatis%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/mybatis1/" class="post-title-link" itemprop="url">【1开发】【Mybatis源码学习笔记】01 - Mybatis整体结构</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/Mybatis%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Mybatis源码学习笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>Mybatis源码学习参考资料：<br><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1iX4y1B7rh/?spm_id_from=333.999.0.0">https://www.bilibili.com/video/BV1iX4y1B7rh/?spm_id_from=333.999.0.0</a></p>
<p><a target="_blank" rel="noopener" href="https://www.iocoder.cn/MyBatis/good-collection/">https://www.iocoder.cn/MyBatis/good-collection/</a></p>
</blockquote>
<h1 id="简单回顾MyBatis使用流程"><a href="#简单回顾MyBatis使用流程" class="headerlink" title="简单回顾MyBatis使用流程"></a>简单回顾MyBatis使用流程</h1><p><strong>mybatis开发环境</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 准备jar</span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">     &lt;groupId&gt;org.mybatis&lt;/groupId&gt;</span><br><span class="line">     &lt;artifactId&gt;mybatis&lt;/artifactId&gt;</span><br><span class="line">  &lt;/dependency&gt;</span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">  &lt;/dependency&gt;</span><br><span class="line"><span class="number">2.</span> 准备配置文件</span><br><span class="line">   a. 基本配置文件 mybatis-config.xml</span><br><span class="line">      <span class="number">1.</span> 数据源的设置 environments</span><br><span class="line">      <span class="number">2.</span> 类型别名</span><br><span class="line">      <span class="number">3.</span> mapper文件的注册</span><br><span class="line">   b. Mapper文件</span><br><span class="line">      <span class="number">1.</span> DAO规定方法的实现 --&gt; SQL语句 </span><br></pre></td></tr></table></figure>

<p><strong>核心代码分析</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Resources.getResourceAsStream(<span class="string">&quot;mybatis-config.xml&quot;</span>);</span><br><span class="line"><span class="type">SqlSessionFactory</span> <span class="variable">sqlSessionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>().build(inputStream);</span><br><span class="line"><span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> sqlSessionFactory.openSession();</span><br><span class="line"><span class="comment">//两种调用方式【方式1可读性更好，方式1是通过代理对方式2的封装】</span></span><br><span class="line">方式<span class="number">1</span>：</span><br><span class="line"><span class="type">UserDAO</span> <span class="variable">userDAO</span> <span class="operator">=</span> sqlSession.getMapper(UserDAO.class);</span><br><span class="line">List&lt;User&gt; users = userDAO.queryAllUsersByPage();</span><br><span class="line">方式<span class="number">2</span>：</span><br><span class="line">List&lt;User&gt; users = sqlSession.selectList(<span class="string">&quot;com.baizhiedu.dao.UserDAO.queryAllUsers&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>那么我们需要关注的点有</p>
<ul>
<li>如何读取的xml —&gt; Configuration</li>
<li>如何创建的sqlSession</li>
<li>如何得到的DAO实现类</li>
<li>真正执行的查询方法调用了什么</li>
<li>。。。。。。。</li>
</ul>
<h1 id="MyBatis核心对象"><a href="#MyBatis核心对象" class="headerlink" title="MyBatis核心对象"></a>MyBatis核心对象</h1><h2 id="核心对象1-数据存储类对象【Mybatis是怎么存的那两种xml】"><a href="#核心对象1-数据存储类对象【Mybatis是怎么存的那两种xml】" class="headerlink" title="核心对象1 数据存储类对象【Mybatis是怎么存的那两种xml】"></a>核心对象1 数据存储类对象【Mybatis是怎么存的那两种xml】</h2><p>概念：在Java中（JVM）对Mybatis相关的配置信息进行封装</p>
<ol>
<li>mybatis-config.xml —-&gt; Configuration</li>
<li>XXXDAOMapper.xml —-&gt; MappedStatement</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  简单看一下Configuration类</span></span><br><span class="line"><span class="comment">//  1. 封装mybatis-config.xml相关的内容【setting、environment、typeAliases】</span></span><br><span class="line"><span class="comment">//  2. 所有Mappper文件相关的内容，在这里进行了汇总</span></span><br><span class="line"><span class="comment">//  3. 负责创建了Mybatis其他的核心对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Configuration</span> &#123;</span><br><span class="line">  <span class="comment">// environment数据源</span></span><br><span class="line">  <span class="keyword">protected</span> Environment environment;</span><br><span class="line">  <span class="comment">// settings里的各种信息</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="type">boolean</span> <span class="variable">cacheEnabled</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Mappers</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">final</span> Set&lt;String&gt; loadedResources = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;String&gt;();</span><br><span class="line">  <span class="comment">// 每个Mappper里对应的mappedStatement和resultMap等</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">final</span> Map&lt;String, MappedStatement&gt; mappedStatements = <span class="keyword">new</span> <span class="title class_">StrictMap</span>&lt;MappedStatement&gt;(<span class="string">&quot;Mapped Statements collection&quot;</span>);</span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">final</span> Map&lt;String, ResultMap&gt; resultMaps = <span class="keyword">new</span> <span class="title class_">StrictMap</span>&lt;ResultMap&gt;(<span class="string">&quot;Result Maps collection&quot;</span>);</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// 负责创建mybatis中其他核心对象</span></span><br><span class="line">  <span class="keyword">public</span> ParameterHandler <span class="title function_">newParameterHandler</span><span class="params">()</span>&#123;&#125;</span><br><span class="line">  <span class="keyword">public</span> ResultSetHandler <span class="title function_">newResultSetHandler</span><span class="params">()</span>&#123;&#125;</span><br><span class="line">  <span class="keyword">public</span> Executor <span class="title function_">newExecutor</span><span class="params">()</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 看一下MappedStatement</span></span><br><span class="line">对应的就是 Mapper文件中的一个一个的 配置标签 </span><br><span class="line">&lt;select id....&gt; -----&gt; MappedStatement</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">MappedStatement</span> &#123;</span><br><span class="line">  <span class="comment">// 标签中的各种属性</span></span><br><span class="line">  <span class="keyword">private</span> String id;</span><br><span class="line">  <span class="comment">// 1.普通，没有预编译效率太低；2.prepared，预编译阶段；3.callable，用于存储过程</span></span><br><span class="line">  <span class="keyword">private</span> StatementType statementType;【默认是prepared】</span><br><span class="line">  <span class="keyword">private</span> ResultSetType resultSetType;</span><br><span class="line">  <span class="comment">// Configuration【mapper可以拿到config，config也可以拿到mapper】</span></span><br><span class="line">  <span class="keyword">private</span> Configuration configuration;</span><br><span class="line">  <span class="comment">// 真正SQL语句的封装</span></span><br><span class="line">  <span class="keyword">public</span> BoundSql <span class="title function_">getBoundSql</span><span class="params">()</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="核心对象2-操作对象"><a href="#核心对象2-操作对象" class="headerlink" title="核心对象2 操作对象"></a>核心对象2 操作对象</h2><h3 id="核心对象2-1-Executor，处理功能的核心接口【Simple，Batch，Reuse】"><a href="#核心对象2-1-Executor，处理功能的核心接口【Simple，Batch，Reuse】" class="headerlink" title="核心对象2.1 Executor，处理功能的核心接口【Simple，Batch，Reuse】"></a>核心对象2.1 Executor，处理功能的核心接口【Simple，Batch，Reuse】</h3><ol>
<li>增删改（update）,查（query）</li>
<li>事务操作（提交，回滚）</li>
<li>缓存相关的操作</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Executor</span> &#123;</span><br><span class="line">	<span class="comment">//增删改查</span></span><br><span class="line">  <span class="type">int</span> <span class="title function_">update</span><span class="params">(MappedStatement ms, Object parameter)</span>;</span><br><span class="line">  &lt;E&gt; List&lt;E&gt; <span class="title function_">query</span><span class="params">()</span>&#123;&#125; </span><br><span class="line"></span><br><span class="line">  <span class="comment">//事务操作（提交，回滚）</span></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">()</span>&#123;&#125;</span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">rollback</span><span class="params">()</span>&#123;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//缓存</span></span><br><span class="line">  CacheKey <span class="title function_">createCacheKey</span><span class="params">()</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>Executor的几个核心实现类</strong></p>
<ul>
<li><p>特别地，有个BaseExecutor【适配器模式】</p>
</li>
<li><p>BatchExcutor【批处理】</p>
<ul>
<li>JDBC中的批处理操作</li>
<li>由于connecttion非常珍贵，在一次connection进行多次sql操作</li>
</ul>
</li>
<li><p>ReuseExcutor【复用】</p>
<ul>
<li>复用statement</li>
</ul>
</li>
<li><p>SimpleExecutor【默认的，推荐的】</p>
</li>
</ul>
<h2 id="核心对象2-2-StatementHandler"><a href="#核心对象2-2-StatementHandler" class="headerlink" title="核心对象2.2 StatementHandler"></a>核心对象2.2 StatementHandler</h2><p>包装了Executor中，真正进行<strong>Executor中的增删改查</strong>部分工作</p>
<p>【SimpleStatementHandler，PreparedStatementHandler，CallableStatementHandler】</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleStatementHandler</span> <span class="keyword">extends</span> <span class="title class_">BaseStatementHandler</span> &#123;</span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="title function_">query</span><span class="params">(Statement statement, ResultHandler resultHandler)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> boundSql.getSql();</span><br><span class="line">    statement.execute(sql);</span><br><span class="line">    <span class="keyword">return</span> resultSetHandler.&lt;E&gt;handleResultSets(statement);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="核心对象2-3-ParameterHandler、ResultSetHandler、TypeHandler"><a href="#核心对象2-3-ParameterHandler、ResultSetHandler、TypeHandler" class="headerlink" title="核心对象2.3 ParameterHandler、ResultSetHandler、TypeHandler"></a>核心对象2.3 ParameterHandler、ResultSetHandler、TypeHandler</h2><ul>
<li><p>ParameterHandler<br>目的：Mybatis参数 —》 JDBC 相关的参数<br>     @Param —&gt; #{} — &gt; ?</p>
</li>
<li><p>ResultSetHandler<br>目的：对JDBC中查询结果集 ResultSet 进行封装 </p>
</li>
<li><p>TypeHandler</p>
<p>​	 String   —-&gt;   varchar</p>
</li>
</ul>
<h1 id="Mybatis的核心对象-如何与SqlSession建立的联系？"><a href="#Mybatis的核心对象-如何与SqlSession建立的联系？" class="headerlink" title="Mybatis的核心对象 如何与SqlSession建立的联系？"></a>Mybatis的核心对象 如何与SqlSession建立的联系？</h1><h2 id="总结一下Mybatis的简单结构"><a href="#总结一下Mybatis的简单结构" class="headerlink" title="总结一下Mybatis的简单结构"></a>总结一下Mybatis的简单结构</h2><p>SqlSession—&gt;Executor【增删改查接口】—&gt;StatementHandler【增删改查的真正实现】—&gt;调用JDBC中的Statement</p>
<img src="https://raw.githubusercontent.com/cccccc96/cloudimg/main/未命名绘图2.png" alt="未命名绘图2" style="zoom:50%;" />

<h2 id="简单追一下sqlSession-insert-“”-的流程"><a href="#简单追一下sqlSession-insert-“”-的流程" class="headerlink" title="简单追一下sqlSession.insert(“”);的流程"></a>简单追一下sqlSession.insert(“”);的流程</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">sqlSession.insert(“”);</span><br><span class="line"></span><br><span class="line"><span class="comment">//1. interface SqlSession</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">insert</span><span class="params">(String statement)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//2. DefaultSqlSession implements SqlSession</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">insert</span><span class="params">(String statement)</span> &#123; </span><br><span class="line">    <span class="keyword">return</span> insert(statement, <span class="literal">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">insert</span><span class="params">(String statement, Object parameter)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> update(statement, parameter);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">update</span><span class="params">(String statement, Object parameter)</span> &#123;</span><br><span class="line">    <span class="comment">// statement就是key，也就是namespace.id</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      dirty = <span class="literal">true</span>;</span><br><span class="line">      <span class="comment">// 拿mapper里key对应的那个insert标签</span></span><br><span class="line">      <span class="type">MappedStatement</span> <span class="variable">ms</span> <span class="operator">=</span> configuration.getMappedStatement(statement);</span><br><span class="line">      <span class="comment">// 交给executor来帮它做【默认是simpleExecutor】</span></span><br><span class="line">      <span class="keyword">return</span> executor.update(ms, wrapCollection(parameter));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">&quot;Error updating database.  Cause: &quot;</span> + e, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//3。 BaseExecutor</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">update</span><span class="params">(MappedStatement ms, Object parameter)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    ErrorContext.instance().resource(ms.getResource()).activity(<span class="string">&quot;executing an update&quot;</span>).object(ms.getId());</span><br><span class="line">    <span class="keyword">if</span> (closed) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ExecutorException</span>(<span class="string">&quot;Executor was closed.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    clearLocalCache();</span><br><span class="line">    <span class="keyword">return</span> doUpdate(ms, parameter);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//4. SimpleExecutor</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">doUpdate</span><span class="params">(MappedStatement ms, Object parameter)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="type">Configuration</span> <span class="variable">configuration</span> <span class="operator">=</span> ms.getConfiguration();</span><br><span class="line">      <span class="type">StatementHandler</span> <span class="variable">handler</span> <span class="operator">=</span> configuration.newStatementHandler(<span class="built_in">this</span>, ms, parameter, RowBounds.DEFAULT, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">      <span class="comment">// 获取prepareStatement</span></span><br><span class="line">      stmt = prepareStatement(handler, ms.getStatementLog());</span><br><span class="line">      <span class="comment">// 由handler去做update</span></span><br><span class="line">      <span class="keyword">return</span> handler.update(stmt);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      closeStatement(stmt);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="那么，实际编码中，我们采用的“dao-sqlSession-getMapper-xxxDAO-class-dao-queryXXX-”是如何进一步封装的？【代理】"><a href="#那么，实际编码中，我们采用的“dao-sqlSession-getMapper-xxxDAO-class-dao-queryXXX-”是如何进一步封装的？【代理】" class="headerlink" title="那么，实际编码中，我们采用的“dao &#x3D; sqlSession.getMapper(xxxDAO.class); dao.queryXXX();”是如何进一步封装的？【代理】"></a>那么，实际编码中，我们采用的“dao &#x3D; sqlSession.getMapper(xxxDAO.class); dao.queryXXX();”是如何进一步封装的？【代理】</h2><p>debug一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dao： org.apache.ibatis.binding.MapperProxy@316bcf94</span></span><br><span class="line">dao = sqlSession.getMapper(xxxDAO.class); </span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/mybatis%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/mybatis2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/mybatis%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/mybatis2/" class="post-title-link" itemprop="url">【1开发】【Mybatis源码学习笔记】02 - 如何通过代理封装DAO接口</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/Mybatis%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Mybatis源码学习笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="先简单看一下Dao接口的实现类"><a href="#先简单看一下Dao接口的实现类" class="headerlink" title="先简单看一下Dao接口的实现类"></a>先简单看一下Dao接口的实现类</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserDAO</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">queryAllUsersByPage</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">UserDAO</span> <span class="variable">userDao</span> <span class="operator">=</span> SqlSessin.getMapper(UserDao.class);</span><br><span class="line"><span class="comment">// 可以看到，我们只写了UserMapper这个xml，但是mybatis却能给我们返回userDao的实现类！</span></span><br></pre></td></tr></table></figure>

<ul>
<li>如何创建这个UserDAO实现类的？<ul>
<li>动态字节码技术   —-&gt;类在JVM运行时创建</li>
</ul>
</li>
<li>实现类是如何实现的？<ul>
<li>代理对象，调用上一节笔记里的SqlSession的底层实现【sqlSession.select，executor，statementhandler】</li>
</ul>
</li>
</ul>
<p>所以我们可以自己用<strong>动态代理</strong>实现一个<strong>简易版的UserDAO实现类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyMapperProxy</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SqlSession sqlSession;</span><br><span class="line">    <span class="keyword">private</span> Class daoClass;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyMapperProxy</span><span class="params">(SqlSession sqlSession, Class daoClass)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sqlSession = sqlSession;</span><br><span class="line">        <span class="built_in">this</span>.daoClass = daoClass;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(daoClass.getName() + <span class="string">&quot;.&quot;</span> + method.getName());</span><br><span class="line">        <span class="keyword">return</span> sqlSession.selectList(daoClass.getName() + <span class="string">&quot;.&quot;</span> + method.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> <span class="type">UserDAO</span> <span class="variable">userDAO</span> <span class="operator">=</span> (UserDAO) Proxy.newProxyInstance(TestMybatis.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;UserDAO.class&#125;</span><br><span class="line">                                                 ,<span class="keyword">new</span> <span class="title class_">MyMapperProxy</span>(sqlSession,UserDAO.class));</span><br></pre></td></tr></table></figure>

<h1 id="Dao接口的实现类，看一下实际源码"><a href="#Dao接口的实现类，看一下实际源码" class="headerlink" title="Dao接口的实现类，看一下实际源码"></a>Dao接口的实现类，看一下实际源码</h1><p><strong><u>核心就是两点：1.使用了代理设计模式；2.底层还是调用sqlSession.insert&#x2F;delete….</u></strong></p>
<p><strong><u>更细节，还封装了mapperMethod，其中实现的execute方法</u></strong></p>
<h2 id="1-MapperProxyFactory【动态代理类工厂】"><a href="#1-MapperProxyFactory【动态代理类工厂】" class="headerlink" title="1.MapperProxyFactory【动态代理类工厂】"></a>1.MapperProxyFactory【动态代理类工厂】</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MapperProxyFactory</span>&lt;T&gt; &#123;</span><br><span class="line">	<span class="comment">//可以看到，源码里也是用JDK动态代理实现的</span></span><br><span class="line">  <span class="keyword">protected</span> T <span class="title function_">newInstance</span><span class="params">(MapperProxy&lt;T&gt; mapperProxy)</span> &#123;</span><br><span class="line">    <span class="comment">// 核心要实现mapperProxy</span></span><br><span class="line">    <span class="keyword">return</span> (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; mapperInterface &#125;, mapperProxy);</span><br><span class="line">  &#125;</span><br><span class="line">   <span class="keyword">public</span> T <span class="title function_">newInstance</span><span class="params">(SqlSession sqlSession)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> MapperProxy&lt;T&gt; mapperProxy = <span class="keyword">new</span> <span class="title class_">MapperProxy</span>&lt;T&gt;(sqlSession, mapperInterface, methodCache);</span><br><span class="line">    <span class="keyword">return</span> newInstance(mapperProxy);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="2-mapperProxy【动态代理应该实现的额外功能，也就是调用sqlSession对象】"><a href="#2-mapperProxy【动态代理应该实现的额外功能，也就是调用sqlSession对象】" class="headerlink" title="2. mapperProxy【动态代理应该实现的额外功能，也就是调用sqlSession对象】"></a>2. mapperProxy【动态代理应该实现的额外功能，也就是调用sqlSession对象】</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MapperProxy</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span>, Serializable &#123;</span><br><span class="line">  <span class="comment">// sqlSession和Dao接口</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> SqlSession sqlSession;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;T&gt; mapperInterface;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="comment">// 先判断是否是Object类型，比如要执行的是toString这种方法，原样运行</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (Object.class.equals(method.getDeclaringClass())) &#123;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(<span class="built_in">this</span>, args);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isDefaultMethod(method)) &#123;</span><br><span class="line">        <span class="keyword">return</span> invokeDefaultMethod(proxy, method, args);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">      <span class="keyword">throw</span> ExceptionUtil.unwrapThrowable(t);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 原有DAO接口的一个封装</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">MapperMethod</span> <span class="variable">mapperMethod</span> <span class="operator">=</span> cachedMapperMethod(method);</span><br><span class="line">    <span class="comment">// 除了Object之外的，我们才应该执行sqlSession对应的方法</span></span><br><span class="line">    <span class="keyword">return</span> mapperMethod.execute(sqlSession, args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-1-MapperMethod【为什么要封装原有DAO接口】"><a href="#2-1-MapperMethod【为什么要封装原有DAO接口】" class="headerlink" title="2.1  MapperMethod【为什么要封装原有DAO接口】"></a>2.1  MapperMethod【为什么要封装原有DAO接口】</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MapperMethod</span> &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// MapperMethod的目的：</span></span><br><span class="line">  <span class="comment">// 通过DAO接口和DAO接口中的方法，封装了下面两个变量</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> SqlCommand command;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> MethodSignature method;</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// Configuration:所有mybatis的数据</span></span><br><span class="line">  <span class="comment">// mapperInterface/Method：DAO接口，DAO接口里的方法</span></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">MapperMethod</span><span class="params">(Class&lt;?&gt; mapperInterface, Method method, Configuration config)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.command = <span class="keyword">new</span> <span class="title class_">SqlCommand</span>(config, mapperInterface, method);</span><br><span class="line">    <span class="built_in">this</span>.method = <span class="keyword">new</span> <span class="title class_">MethodSignature</span>(config, mapperInterface, method);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// execute：调用sqlSession</span></span><br><span class="line">  <span class="comment">// 【根据command的类型，调用INSERT, UPDATE, DELETE, SELECT】</span></span><br><span class="line">	<span class="keyword">public</span> Object <span class="title function_">execute</span><span class="params">(SqlSession sqlSession, Object[] args)</span> &#123;</span><br><span class="line">    Object result;</span><br><span class="line">    <span class="keyword">switch</span> (command.getType()) &#123;</span><br><span class="line">      <span class="keyword">case</span> INSERT: &#123;</span><br><span class="line">      <span class="type">Object</span> <span class="variable">param</span> <span class="operator">=</span> method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.insert(command.getName(), param));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> UPDATE: &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">param</span> <span class="operator">=</span> method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.update(command.getName(), param));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//........</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MapperMethod中的成员变量1</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SqlCommand</span> &#123;</span><br><span class="line">		<span class="comment">// name：存了namespace.id</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">   <span class="comment">// type：这是什么类型的？【INSERT, UPDATE, DELETE, SELECT】</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SqlCommandType type;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SqlCommand</span><span class="params">(Configuration configuration, Class&lt;?&gt; mapperInterface, Method method)</span> &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> method.getName();</span><br><span class="line">      <span class="keyword">final</span> Class&lt;?&gt; declaringClass = method.getDeclaringClass();</span><br><span class="line">      <span class="type">MappedStatement</span> <span class="variable">ms</span> <span class="operator">=</span> resolveMappedStatement(mapperInterface, methodName, declaringClass,</span><br><span class="line">          configuration);</span><br><span class="line">      <span class="keyword">if</span> (ms == <span class="literal">null</span>) &#123;  <span class="comment">// null就不管了</span></span><br><span class="line">        <span class="keyword">if</span> (method.getAnnotation(Flush.class) != <span class="literal">null</span>) &#123;</span><br><span class="line">          name = <span class="literal">null</span>;</span><br><span class="line">          type = SqlCommandType.FLUSH;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BindingException</span>(<span class="string">&quot;Invalid bound statement (not found): &quot;</span></span><br><span class="line">              + mapperInterface.getName() + <span class="string">&quot;.&quot;</span> + methodName);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 核心在这里</span></span><br><span class="line">        name = ms.getId();   <span class="comment">//namespace.id</span></span><br><span class="line">        type = ms.getSqlCommandType();   </span><br><span class="line">        <span class="keyword">if</span> (type == SqlCommandType.UNKNOWN) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BindingException</span>(<span class="string">&quot;Unknown execution method for: &quot;</span> + name);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MapperMethod中的成员变量2 </span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MethodSignature</span> &#123;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// sql语句里的信息：返回值、参数、有没有分页......</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> returnsMany;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> returnsMap;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> returnsVoid;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> returnsCursor;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; returnType;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String mapKey;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Integer resultHandlerIndex;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Integer rowBoundsIndex;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ParamNameResolver paramNameResolver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="总结一下，DAO代理创建的流程"><a href="#总结一下，DAO代理创建的流程" class="headerlink" title="总结一下，DAO代理创建的流程"></a>总结一下，DAO代理创建的流程</h1><h2 id="暴露出来的接口"><a href="#暴露出来的接口" class="headerlink" title="暴露出来的接口"></a>暴露出来的接口</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">XXXDAO</span> <span class="variable">dao</span> <span class="operator">=</span> SqlSession.getMapper(XXXDAO.class);</span><br><span class="line">dao.queryxxx();</span><br></pre></td></tr></table></figure>

<h2 id="该接口的底层实现流程"><a href="#该接口的底层实现流程" class="headerlink" title="该接口的底层实现流程"></a>该接口的底层实现流程</h2><p><strong><u>核心：SqlSession.getMapper —–&gt; 动态代理【DAO接口的实现类】</u></strong></p>
<ul>
<li>MappedProxyFactory<strong>【JDK动态代理】</strong><ul>
<li>MapperProxy【InvocationHandler】<ul>
<li>SQLCommand<strong>【成员变量1】</strong><ul>
<li>Type[insert|update|delete|select]</li>
<li>Name[namespace.id]</li>
</ul>
</li>
<li>MethodSingature<strong>【成员变量2】</strong><ul>
<li>方法的返回值</li>
<li>参数</li>
</ul>
</li>
<li>SqlSession.update()&#x2F;delete()<strong>【使用封装的Executor和StatementHandler，调用底层JDBC的statement】</strong><ul>
<li>Executor[simple|reuse|batch]<ul>
<li>StatementHandler<ul>
<li>ParameterHandler、ResultSetHandler</li>
<li>调用底层JDBC</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/mybatis%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/mybatis3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/mybatis%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/mybatis3/" class="post-title-link" itemprop="url">【1开发】【Mybatis源码学习笔记】03 - 如何得到一个sqlSession，流程梳理【读xml + 工厂创建sqlSession】</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/Mybatis%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Mybatis源码学习笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="生成SqlSession【用户使用】"><a href="#生成SqlSession【用户使用】" class="headerlink" title="生成SqlSession【用户使用】"></a>生成SqlSession【用户使用】</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.打开输入流，读取mybatis-config.xml和其中包含的所有XXXMapper.xml</span></span><br><span class="line"><span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Resources.getResourceAsStream(<span class="string">&quot;mybatis-config.xml&quot;</span>);</span><br><span class="line"><span class="comment">// 2.xml里所有的信息，都封装到Configuration里</span></span><br><span class="line"><span class="type">SqlSessionFactory</span> <span class="variable">sqlSessionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>().build(inputStream);</span><br><span class="line"><span class="comment">// 3.工厂创建sqlSession</span></span><br><span class="line"><span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> sqlSessionFactory.openSession();</span><br></pre></td></tr></table></figure>

<p>所以，我们核心就是要分析**<u>第2行和第3行</u>**</p>
<ul>
<li>xml怎么封装成<strong>Configuration</strong></li>
<li>工厂怎么<strong>创建SqlSession里的那些executor</strong>等等</li>
</ul>
<h1 id="生成SqlSession【底层实现】"><a href="#生成SqlSession【底层实现】" class="headerlink" title="生成SqlSession【底层实现】"></a>生成SqlSession【底层实现】</h1><h2 id="1-XML解析【mybatis-config-xml和Mapper-xml】"><a href="#1-XML解析【mybatis-config-xml和Mapper-xml】" class="headerlink" title="1. XML解析【mybatis-config.xml和Mapper.xml】"></a>1. XML解析【mybatis-config.xml和Mapper.xml】</h2><blockquote>
<p>&#x2F;&#x2F; 2.xml里所有的信息，都封装到Configuration里</p>
<p>SqlSessionFactory sqlSessionFactory &#x3D; new SqlSessionFactoryBuilder().build(inputStream);</p>
</blockquote>
<p>简单学一下XML是怎么解析的</p>
<p>使用工具<strong>XPathParser</strong>所有XML里的信息会被解析成一个个<strong>XNode</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//    &lt;users&gt;  </span></span><br><span class="line"><span class="comment">//       &lt;user id=&quot;1&quot;&gt;</span></span><br><span class="line"><span class="comment">//           &lt;name&gt;xiaohei&lt;/name&gt;</span></span><br><span class="line"><span class="comment">//           &lt;password&gt;2222&lt;/password&gt;</span></span><br><span class="line"><span class="comment">//      &lt;/user&gt;</span></span><br><span class="line"><span class="comment">//   &lt;/users&gt;</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XNode</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Node node;	</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String name;  <span class="comment">// &lt;users&gt;,&lt;name&gt;</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String body;  <span class="comment">// xiaohei,2222</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Properties attributes;  <span class="comment">// id=&quot;1&quot;</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Properties variables;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> XPathParser xpathParser;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在，可以看<strong>Mybatis是怎么解析</strong>mybatis-config.xml和其中包含的所有XXXMapper.xml的了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>().build(inputStream);</span><br><span class="line"> <span class="comment">// build最终会调用这个parse方法，执行parseConfiguration(parser.evalNode(&quot;/configuration&quot;))</span></span><br><span class="line"><span class="comment">// 根据xml，封装成Configuration对象</span></span><br><span class="line"><span class="keyword">public</span> Configuration <span class="title function_">parse</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (parsed) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BuilderException</span>(<span class="string">&quot;Each XMLConfigBuilder can only be used once.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    parsed = <span class="literal">true</span>;</span><br><span class="line">    parseConfiguration(parser.evalNode(<span class="string">&quot;/configuration&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span> configuration;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 可以看到，这里是读取mybatis-config.xml里的一些配置信息【但我们还要读mapper.xml，从mapperElement方法进去】</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">parseConfiguration</span><span class="params">(XNode root)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      propertiesElement(root.evalNode(<span class="string">&quot;properties&quot;</span>));</span><br><span class="line">			。。。。。。。</span><br><span class="line">      mapperElement(root.evalNode(<span class="string">&quot;mappers&quot;</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BuilderException</span>(<span class="string">&quot;Error parsing SQL Mapper Configuration. Cause: &quot;</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 开始读取mappers，核心是mapperParser.parse();</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">mapperElement</span><span class="params">(XNode parent)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    。。。。。。</span><br><span class="line">            ErrorContext.instance().resource(resource);</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Resources.getResourceAsStream(resource);</span><br><span class="line">            <span class="type">XMLMapperBuilder</span> <span class="variable">mapperParser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLMapperBuilder</span>(inputStream, configuration, resource, configuration.getSqlFragments());</span><br><span class="line">            <span class="comment">// 调用该方法，将会得到mappedstatement</span></span><br><span class="line">            mapperParser.parse();</span><br><span class="line">          &#125;</span><br><span class="line">	。。。。。。。</span><br><span class="line">       </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.1 真正解析Mapper里的内容</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">configurationElement</span><span class="params">(XNode context)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="type">String</span> <span class="variable">namespace</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;namespace&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (namespace == <span class="literal">null</span> || namespace.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BuilderException</span>(<span class="string">&quot;Mapper&#x27;s namespace cannot be empty&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      builderAssistant.setCurrentNamespace(namespace);</span><br><span class="line">      cacheRefElement(context.evalNode(<span class="string">&quot;cache-ref&quot;</span>));</span><br><span class="line">      cacheElement(context.evalNode(<span class="string">&quot;cache&quot;</span>));</span><br><span class="line">      parameterMapElement(context.evalNodes(<span class="string">&quot;/mapper/parameterMap&quot;</span>));</span><br><span class="line">      resultMapElements(context.evalNodes(<span class="string">&quot;/mapper/resultMap&quot;</span>));</span><br><span class="line">      sqlElement(context.evalNodes(<span class="string">&quot;/mapper/sql&quot;</span>));</span><br><span class="line">      <span class="comment">// 那么，核心就是这里读取statement</span></span><br><span class="line">      buildStatementFromContext(context.evalNodes(<span class="string">&quot;select|insert|update|delete&quot;</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BuilderException</span>(<span class="string">&quot;Error parsing Mapper XML. The XML location is &#x27;&quot;</span> + resource + <span class="string">&quot;&#x27;. Cause: &quot;</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.1.1 读取Mapper里的statement</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">buildStatementFromContext</span><span class="params">(List&lt;XNode&gt; list, String requiredDatabaseId)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (XNode context : list) &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="type">XMLStatementBuilder</span> <span class="variable">statementParser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLStatementBuilder</span>(configuration, builderAssistant, context, requiredDatabaseId);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 这里进去</span></span><br><span class="line">        statementParser.parseStatementNode();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IncompleteElementException e) &#123;</span><br><span class="line">        configuration.addIncompleteStatement(statementParser);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parseStatementNode</span><span class="params">()</span> &#123;</span><br><span class="line">  	<span class="comment">// 获取所有属性</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">databaseId</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;databaseId&quot;</span>);</span><br><span class="line">		。。。。。。</span><br><span class="line">    <span class="comment">// 再进这里</span></span><br><span class="line">    builderAssistant.addMappedStatement(id, sqlSource, statementType, sqlCommandType,</span><br><span class="line">        fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass,</span><br><span class="line">        resultSetTypeEnum, flushCache, useCache, resultOrdered, </span><br><span class="line">        keyGenerator, keyProperty, keyColumn, databaseId, langDriver, resultSets);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> MappedStatement <span class="title function_">addMappedStatement</span><span class="params">()</span>&#123;</span><br><span class="line">  ......</span><br><span class="line">    <span class="comment">// 构建者模式，构建MappedStatement。到这里从xml，真正封装成了MappedStatement</span></span><br><span class="line">        MappedStatement.<span class="type">Builder</span> <span class="variable">statementBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MappedStatement</span>.Builder(configuration, id, sqlSource, sqlCommandType)</span><br><span class="line">        .resource(resource)</span><br><span class="line">        .fetchSize(fetchSize)</span><br><span class="line">        .timeout(timeout)</span><br><span class="line">        <span class="type">ParameterMap</span> <span class="variable">statementParameterMap</span> <span class="operator">=</span> getStatementParameterMap(parameterMap, parameterType, id);</span><br><span class="line">    <span class="keyword">if</span> (statementParameterMap != <span class="literal">null</span>) &#123;</span><br><span class="line">      statementBuilder.parameterMap(statementParameterMap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">MappedStatement</span> <span class="variable">statement</span> <span class="operator">=</span> statementBuilder.build();</span><br><span class="line">    。。。。。。</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="2-工厂创建SqlSession"><a href="#2-工厂创建SqlSession" class="headerlink" title="2. 工厂创建SqlSession"></a>2. 工厂创建SqlSession</h2><blockquote>
<p>&#x2F;&#x2F; 3.工厂创建sqlSession<br>SqlSession sqlSession &#x3D; sqlSessionFactory.openSession();</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> SqlSession <span class="title function_">openSessionFromDataSource</span><span class="params">(ExecutorType execType, TransactionIsolationLevel level, <span class="type">boolean</span> autoCommit)</span> &#123;</span><br><span class="line">    <span class="type">Transaction</span> <span class="variable">tx</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 获取连接池这些东西</span></span><br><span class="line">      <span class="keyword">final</span> <span class="type">Environment</span> <span class="variable">environment</span> <span class="operator">=</span> configuration.getEnvironment();</span><br><span class="line">      <span class="comment">// 处理事务</span></span><br><span class="line">      <span class="keyword">final</span> <span class="type">TransactionFactory</span> <span class="variable">transactionFactory</span> <span class="operator">=</span> getTransactionFactoryFromEnvironment(environment);</span><br><span class="line">      tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);</span><br><span class="line">      <span class="comment">// 获取Executor</span></span><br><span class="line">      <span class="keyword">final</span> <span class="type">Executor</span> <span class="variable">executor</span> <span class="operator">=</span> configuration.newExecutor(tx, execType);</span><br><span class="line">      <span class="comment">// 有了上面这些东西，自然可以创建SqlSession了【autoCommit代表事务提交方式，默认是不提交】</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultSqlSession</span>(configuration, executor, autoCommit);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      closeTransaction(tx); <span class="comment">// may have fetched a connection so lets call close()</span></span><br><span class="line">      <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">&quot;Error opening session.  Cause: &quot;</span> + e, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-总结一下上面两步的流程"><a href="#3-总结一下上面两步的流程" class="headerlink" title="3. 总结一下上面两步的流程"></a>3. 总结一下上面两步的流程</h3><p><strong>第一，</strong>通过 <strong>xPathParser XNode</strong>，解析 <strong>mybatis-config.xml</strong> —-&gt; <strong>Configuration</strong> 对象 </p>
<ul>
<li>解析configuration的属性 <ul>
<li>parseConfiguration(parser.evalNode(“&#x2F;configuration”))</li>
</ul>
</li>
<li>解析Mapper.xml，生成MappedStatement，并且存放在 Configution中<ul>
<li>parseConfiguration<ul>
<li>mapperElement(root.evalNode(“mappers”));<ul>
<li>new XMLMapperBuilder();<ul>
<li>mapperParser.parse();     <ul>
<li>configurationElement(parser.evalNode(“&#x2F;mapper”));<ul>
<li>statementParser.parseStatementNode();<ul>
<li>builderAssistant.addMappedStatement<ul>
<li>​	MappedStatement statement &#x3D; statementBuilder.build();</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>第二，</strong>现在Configuration封装好了，就可以<strong>new</strong> DefaultSqlSessionFactory(Configuration); 得到了SqlSession工厂</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>目前，已经能知道Mybatis是如何走完一个简单的查询</p>
<p><img src="/../../../../../../../../Downloads/Mybait.png" alt="Mybait"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/mybatis%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/mybatis4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/mybatis%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/mybatis4/" class="post-title-link" itemprop="url">【1开发】【Mybatis源码学习笔记】04 - 缓存</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/Mybatis%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Mybatis源码学习笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>sqlSession在和数据库交互的过程中，帮我们实现了一种缓存【Mybatis自带的】</p>
<h1 id="直接进入Cache接口里看一下"><a href="#直接进入Cache接口里看一下" class="headerlink" title="直接进入Cache接口里看一下"></a>直接进入Cache接口里看一下</h1><img src="https://raw.githubusercontent.com/cccccc96/cloudimg/main/image-20240805143321913.png" alt="image-20240805143321913" style="zoom:50%;" />

<p>可以看到，接口里定义了缓存一些常用的功能。和我们自己平常用缓存并没有什么区别。</p>
<p>看一下实现类。</p>
<img src="https://raw.githubusercontent.com/cccccc96/cloudimg/main/image-20240805165906305.png" alt="image-20240805165906305" style="zoom:50%;" />

<p>Cache的实现类可以分为两类：</p>
<ol>
<li>核心的Cache实现【PerpetualCache】<ol>
<li>相当简单，就是一个HashMap</li>
</ol>
</li>
<li>装饰器【decoreator】<ol>
<li>我们知道装饰器是为了给Cache增加功能，让PerpetualCache更加强大。</li>
<li>例如：new LruCache( new PerpetualCache(“id”))</li>
</ol>
</li>
</ol>
<h2 id="核心的Cache实现【PerpetualCache】"><a href="#核心的Cache实现【PerpetualCache】" class="headerlink" title="核心的Cache实现【PerpetualCache】"></a>核心的Cache实现【PerpetualCache】</h2><p>可以看到，这块代码相当简单。就是一个HashMap，然后里面写数据，读数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PerpetualCache</span> <span class="keyword">implements</span> <span class="title class_">Cache</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String id;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Map&lt;Object, Object&gt; cache = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Object, Object&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">PerpetualCache</span><span class="params">(String id)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.id = id;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">putObject</span><span class="params">(Object key, Object value)</span> &#123;</span><br><span class="line">    cache.put(key, value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> cache.get(key);</span><br><span class="line">  &#125;</span><br><span class="line">  .......</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Cache装饰器【decoreator】"><a href="#Cache装饰器【decoreator】" class="headerlink" title="Cache装饰器【decoreator】"></a>Cache装饰器【decoreator】</h2><p><u>装饰器和之前代理模式的核心区别：一个是增加核心功能，做的是同一件事；但代理增加额外功能，做的是不同的事。</u></p>
<p>目标：为了让PerpetualCache功能更强</p>
<ul>
<li>FIFOCache：先入先出换出策略 </li>
<li>LRUCache ：最少使用策略 【默认的装饰器】</li>
<li>TransactionalCache ：只有在事务操作成功时，把对应的数据放置在缓存</li>
<li>LoggingCache： Cache增加日志功能    </li>
<li>BlockingCache：保证 同一时间 只有一个线程 到缓存中 查找对应key的数据</li>
<li>ScheduledCache：设置时间间隔 清空缓存 </li>
<li>SerializbledCache ：自动完成key value 序列化 反序列操作</li>
</ul>
<p>比较常用的主要是前三个。</p>
<h1 id="Cache在Mybatis中的应用过程"><a href="#Cache在Mybatis中的应用过程" class="headerlink" title="Cache在Mybatis中的应用过程"></a>Cache在Mybatis中的应用过程</h1><h2 id="Cache的体系"><a href="#Cache的体系" class="headerlink" title="Cache的体系"></a>Cache的体系</h2><ul>
<li>一级缓存<ul>
<li>mybatis —&gt; 缓存 —-&gt; 数据库</li>
<li>一级缓存只对单一sqlSession有效</li>
</ul>
</li>
<li>二级缓存</li>
</ul>
<h2 id="一级缓存"><a href="#一级缓存" class="headerlink" title="一级缓存"></a>一级缓存</h2><p>一级缓存的内容体现在BaseExecutor【适配器】中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseExecutor</span> <span class="keyword">implements</span> <span class="title class_">Executor</span> &#123;</span><br><span class="line">  <span class="keyword">protected</span> PerpetualCache localCache;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 查询相关操作</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="title function_">query</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    ErrorContext.instance().resource(ms.getResource()).activity(<span class="string">&quot;executing a query&quot;</span>).object(ms.getId());</span><br><span class="line">    <span class="keyword">if</span> (closed) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ExecutorException</span>(<span class="string">&quot;Executor was closed.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (queryStack == <span class="number">0</span> &amp;&amp; ms.isFlushCacheRequired()) &#123;</span><br><span class="line">      clearLocalCache();</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;E&gt; list;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      queryStack++;</span><br><span class="line">      <span class="comment">// 一级缓存的起作用在这里</span></span><br><span class="line">      <span class="comment">// 要么从缓存里获取数据</span></span><br><span class="line">      list = resultHandler == <span class="literal">null</span> ? (List&lt;E&gt;) localCache.getObject(key) : <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">if</span> (list != <span class="literal">null</span>) &#123;</span><br><span class="line">        handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 要么从数据库里拿数据</span></span><br><span class="line">        list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      queryStack--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (queryStack == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (DeferredLoad deferredLoad : deferredLoads) &#123;</span><br><span class="line">        deferredLoad.load();</span><br><span class="line">      &#125;</span><br><span class="line">      deferredLoads.clear();</span><br><span class="line">      <span class="keyword">if</span> (configuration.getLocalCacheScope() == LocalCacheScope.STATEMENT) &#123;</span><br><span class="line">        clearLocalCache();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> &lt;E&gt; List&lt;E&gt; <span class="title function_">queryFromDatabase</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    List&lt;E&gt; list;</span><br><span class="line">    localCache.putObject(key, EXECUTION_PLACEHOLDER);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 这里交给simpleExecutor执行</span></span><br><span class="line">      list = doQuery(ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      localCache.removeObject(key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 从数据库里拿到之后，放到缓存里面</span></span><br><span class="line">    localCache.putObject(key, list);</span><br><span class="line">    <span class="keyword">if</span> (ms.getStatementType() == StatementType.CALLABLE) &#123;</span><br><span class="line">      localOutputParameterCache.putObject(key, parameter);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>整体流程：</strong></p>
<ul>
<li>BaseExecutor<ul>
<li>PerpetualCache localCache</li>
<li>query<ul>
<li>localCache.get() 不为null，直接返回</li>
<li>否则，进行DB操作</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="二级缓存（全局缓存）"><a href="#二级缓存（全局缓存）" class="headerlink" title="二级缓存（全局缓存）"></a>二级缓存（全局缓存）</h2><p>二级查询【需要存在事务】，使用CachingExecutor【SimpleExecutor的装饰器，增强缓存功能】</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 其实就是当xml里设置了cacheEnabled</span></span><br><span class="line"><span class="comment">// Configuration里的executor，会用CachingExecutor这个装饰器来增强</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Configuration</span> &#123;  </span><br><span class="line">	<span class="keyword">public</span> Executor <span class="title function_">newExecutor</span><span class="params">(Transaction transaction, ExecutorType executorType)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cacheEnabled) &#123;</span><br><span class="line">      <span class="comment">// CachingExecutor【典型的装饰器】</span></span><br><span class="line">      executor = <span class="keyword">new</span> <span class="title class_">CachingExecutor</span>(executor);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> executor;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面看一下CachingExecutor里的查询方法实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="title function_">query</span><span class="params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">  <span class="comment">// 为他准备sql语句</span></span><br><span class="line">  <span class="type">BoundSql</span> <span class="variable">boundSql</span> <span class="operator">=</span> ms.getBoundSql(parameterObject);</span><br><span class="line">  <span class="comment">// 为他准备缓存的key</span></span><br><span class="line">  <span class="type">CacheKey</span> <span class="variable">key</span> <span class="operator">=</span> createCacheKey(ms, parameterObject, rowBounds, boundSql);</span><br><span class="line">  <span class="keyword">return</span> query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="title function_">query</span><span class="params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span></span><br><span class="line">    <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">  <span class="comment">// 先去MappedStatement拿Cache对象</span></span><br><span class="line">  <span class="type">Cache</span> <span class="variable">cache</span> <span class="operator">=</span> ms.getCache();</span><br><span class="line">  <span class="comment">// 缓存不等于null，也就是开启了二级缓存，Mapper里写了Cache</span></span><br><span class="line">  <span class="keyword">if</span> (cache != <span class="literal">null</span>) &#123;</span><br><span class="line">    flushCacheIfRequired(ms);</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="keyword">if</span> (ms.isUseCache() &amp;&amp; resultHandler == <span class="literal">null</span>) &#123;</span><br><span class="line">      ensureNoOutParams(ms, boundSql);</span><br><span class="line">      <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">      <span class="comment">// 获取缓存中key对应的数据</span></span><br><span class="line">      List&lt;E&gt; list = (List&lt;E&gt;) tcm.getObject(cache, key);</span><br><span class="line">      <span class="comment">// 如果没有获取到，那么还是通过SimpleExecutor进行数据库查询，且存到缓存里</span></span><br><span class="line">      <span class="keyword">if</span> (list == <span class="literal">null</span>) &#123;</span><br><span class="line">        list = delegate.&lt;E&gt; query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">        tcm.putObject(cache, key, list); </span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 缓存等于null，也就是禁止二级缓存，这里的delegate也就是原始的SimpleExecutor</span></span><br><span class="line">  <span class="keyword">return</span> delegate.&lt;E&gt; query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>debug一下，首先看一下Cache，<strong>PerpetualCache外面套娃了一堆装饰器Cache</strong></p>
<img src="https://raw.githubusercontent.com/cccccc96/cloudimg/main/image-20240805223734177.png" alt="image-20240805223734177" style="zoom:50%;" />

<h2 id="二级缓存什么时候创建的、怎么创建的"><a href="#二级缓存什么时候创建的、怎么创建的" class="headerlink" title="二级缓存什么时候创建的、怎么创建的"></a>二级缓存什么时候创建的、怎么创建的</h2><p>通过MapperBuilderAssistant里的useNewCache方法进行创建。</p>
<p>有两个类会调用这个方法，正好对应xml形式和注解形式</p>
<img src="https://raw.githubusercontent.com/cccccc96/cloudimg/main/image-20240805224431144.png" alt="image-20240805224431144" style="zoom: 50%;" />

<p>前面看过了，MyBatis里会解析Mapper.xml里的东西。那么当解析到cache标签，就可以执行useNewCache进行创建了。</p>
<p>Ps：构建者设计模式和工厂设计模式的区别：</p>
<ul>
<li>构建者<ul>
<li>new xxxBuilder().build()</li>
<li>不仅注重最终的产品，还注重零件</li>
</ul>
</li>
<li>工厂<ul>
<li>xxxFactory</li>
<li>只注重最终的产品</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Cache <span class="title function_">useNewCache</span><span class="params">(Class&lt;? extends Cache&gt; typeClass,</span></span><br><span class="line"><span class="params">    Class&lt;? extends Cache&gt; evictionClass,</span></span><br><span class="line"><span class="params">    Long flushInterval,</span></span><br><span class="line"><span class="params">    Integer size,</span></span><br><span class="line"><span class="params">    <span class="type">boolean</span> readWrite,</span></span><br><span class="line"><span class="params">    <span class="type">boolean</span> blocking,</span></span><br><span class="line"><span class="params">    Properties props)</span> &#123;</span><br><span class="line">  <span class="comment">// 使用了构建者来创建对象</span></span><br><span class="line">  <span class="type">Cache</span> <span class="variable">cache</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CacheBuilder</span>(currentNamespace)</span><br><span class="line">      .implementation(valueOrDefault(typeClass, PerpetualCache.class))</span><br><span class="line">      .addDecorator(valueOrDefault(evictionClass, LruCache.class))</span><br><span class="line">      .clearInterval(flushInterval)</span><br><span class="line">      .size(size)</span><br><span class="line">      .readWrite(readWrite)</span><br><span class="line">      .blocking(blocking)</span><br><span class="line">      .properties(props)</span><br><span class="line">      .build();</span><br><span class="line">  configuration.addCache(cache);</span><br><span class="line">  currentCache = cache;</span><br><span class="line">  <span class="keyword">return</span> cache;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Cache <span class="title function_">build</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// 默认是PerpetualCache+LruCache</span></span><br><span class="line">  setDefaultImplementations();</span><br><span class="line">  <span class="type">Cache</span> <span class="variable">cache</span> <span class="operator">=</span> newBaseCacheInstance(implementation, id);</span><br><span class="line">  setCacheProperties(cache);</span><br><span class="line">  <span class="comment">// issue #352, do not apply decorators to custom caches</span></span><br><span class="line">  <span class="keyword">if</span> (PerpetualCache.class.equals(cache.getClass())) &#123;</span><br><span class="line">    <span class="keyword">for</span> (Class&lt;? <span class="keyword">extends</span> <span class="title class_">Cache</span>&gt; decorator : decorators) &#123;</span><br><span class="line">      cache = newCacheDecoratorInstance(decorator, cache);</span><br><span class="line">      setCacheProperties(cache);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据cache标签里的配置，增加各种cache装饰器</span></span><br><span class="line">    cache = setStandardDecorators(cache);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!LoggingCache.class.isAssignableFrom(cache.getClass())) &#123;</span><br><span class="line">    cache = <span class="keyword">new</span> <span class="title class_">LoggingCache</span>(cache);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> cache;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setDefaultImplementations</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (implementation == <span class="literal">null</span>) &#123;</span><br><span class="line">    implementation = PerpetualCache.class;</span><br><span class="line">    <span class="keyword">if</span> (decorators.isEmpty()) &#123;</span><br><span class="line">      decorators.add(LruCache.class);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>useNewCache</p>
<ul>
<li>设置默认缓存属性【PerpetualCache+LRU】，所以底层还是PerpetualCache，还是HashMap来存</li>
<li>创建新的实现：Cache cache &#x3D; newBaseCacheInstance(implementation, id);</li>
<li>读取整合XML里的Cache标签</li>
<li>增加Cache装饰器</li>
<li>最终，存放在MapperStatement中</li>
</ul>
<h1 id="二级缓存和一次缓存，谁先查询"><a href="#二级缓存和一次缓存，谁先查询" class="headerlink" title="二级缓存和一次缓存，谁先查询"></a>二级缓存和一次缓存，谁先查询</h1><ul>
<li><p>二级是每个XML对应一个Cache</p>
</li>
<li><p>一级缓存是一个SqlSession对应一个Cache</p>
</li>
</ul>
<p>Executor -&gt; CachingExecutor【二级】 –&gt;BaseExecutor【一级】 –&gt;SimpleExecutor</p>
<p>先二级，再一级</p>
<h1 id="Debug一下二级缓存"><a href="#Debug一下二级缓存" class="headerlink" title="Debug一下二级缓存"></a>Debug一下二级缓存</h1><h2 id="query是否会走二级缓存"><a href="#query是否会走二级缓存" class="headerlink" title="query是否会走二级缓存"></a>query是否会走二级缓存</h2><p>可以看到，MappedStatement里面Cache有了东西，存在PerpetualCache的HashMap中。</p>
<ul>
<li>Key：namespace.id+代入了具体参数的SQL语句</li>
<li>value：查询出来的结果</li>
</ul>
<p><img src="https://raw.githubusercontent.com/cccccc96/cloudimg/main/image-20240805235849442.png" alt="image-20240805235849442"></p>
<h2 id="增删改操作是否会把cache清空"><a href="#增删改操作是否会把cache清空" class="headerlink" title="增删改操作是否会把cache清空"></a>增删改操作是否会把cache清空</h2><p>commit里会把cache里的所有东西都清空</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransactionalCache</span> <span class="keyword">implements</span> <span class="title class_">Cache</span> &#123; </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (clearOnCommit) &#123;</span><br><span class="line">      <span class="comment">// 把缓存所有东西清空</span></span><br><span class="line">      delegate.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    flushPendingEntries();</span><br><span class="line">    reset();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="第三方缓存集成"><a href="#第三方缓存集成" class="headerlink" title="第三方缓存集成"></a>第三方缓存集成</h1><p>Mybatis一级二级缓存，底层用的是HashMap，甚至都不是concurrentHashMap。</p>
<p>所以，需要第三方缓存【JVM缓存：EhCache；缓存中间件：Redis】</p>
<h2 id="JVM缓存"><a href="#JVM缓存" class="headerlink" title="JVM缓存"></a>JVM缓存</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;cache type=<span class="string">&quot;org.mybatis.caches.ehcache.EhcacheCache&quot;</span>&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cccccc96/cloudimg/main/image-20240806094519444.png" alt="image-20240806094519444"></p>
<img src="https://raw.githubusercontent.com/cccccc96/cloudimg/main/image-20240806095215357.png" alt="image-20240806095215357" style="zoom:50%;" />

<p>这时候，cache被替换成了JVM缓存Ehcache。</p>
<h2 id="Redis缓存"><a href="#Redis缓存" class="headerlink" title="Redis缓存"></a>Redis缓存</h2><p>相比JVM</p>
<ul>
<li>存储数据更多</li>
<li>内存管理更好【内存碎片更少】</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/mybatis%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/mybatis5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/mybatis%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/mybatis5/" class="post-title-link" itemprop="url">【1开发】【Mybatis源码学习笔记】05 - plugin</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/Mybatis%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Mybatis源码学习笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="为啥要plugin"><a href="#为啥要plugin" class="headerlink" title="为啥要plugin"></a>为啥要plugin</h1><p>比如，我们想在运行过程中获得SQL语句，以目前的Mybatis源码来看根本办不到。因为Mybatis封装的太狠了。</p>
<p>所以，我们需要plugin。</p>
<h1 id="Mybatis拦截器"><a href="#Mybatis拦截器" class="headerlink" title="Mybatis拦截器"></a>Mybatis拦截器</h1><ul>
<li><p>原始：xxxDAO.save()</p>
</li>
<li><p>现在：由Mybatis拦截器进行拦截，加入一些功能</p>
</li>
<li><p>拦截的是什么：我们知道DAO调用SqlSession调用Executor调用StatementHandler，所以拦截的是<strong>Executor和各种Handler里的方法</strong></p>
</li>
</ul>
<p>也就是说，下面这几张图里Executor和所有Handler的所有方法，都能被拦截器拦截。但是实际使用中，我们一般只会对statementHandler进行拦截。</p>
<img src="https://raw.githubusercontent.com/cccccc96/cloudimg/main/image-20240806123529160.png" alt="image-20240806123529160" style="zoom: 25%;" />

<img src="https://raw.githubusercontent.com/cccccc96/cloudimg/main/image-20240806123634968.png" alt="image-20240806123634968" style="zoom:25%;" />

<img src="https://raw.githubusercontent.com/cccccc96/cloudimg/main/image-20240806123706868.png" alt="image-20240806123706868" style="zoom:25%;" />

<p>我们核心要关注StatementHandler里的三个方法，这三个方法是最常用的拦截方法</p>
<ul>
<li>prepare<ul>
<li>query和update都需要prepare，所以拦截这一个方法，相当于把这两个方法都拦截了</li>
<li>参数是connection，有了connection就可以获取一切信息，等同于JDBC</li>
<li>可以通过invocation.getTarget()获取statementhandler，调用getboundsql获取sql信息</li>
</ul>
</li>
<li>update</li>
<li>query</li>
</ul>
<p>进其中一个实现类RoutingStatementHandler看一下，它主要是根据xml里的定义创建对应的StatementHandler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 和之前的Executor一样，又用到了装饰器设计模式</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RoutingStatementHandler</span> <span class="keyword">implements</span> <span class="title class_">StatementHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> StatementHandler delegate;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">RoutingStatementHandler</span><span class="params">(Executor executor, MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据ms类型，创建对应的StatementHandler【默认是prepared】</span></span><br><span class="line">    <span class="keyword">switch</span> (ms.getStatementType()) &#123;</span><br><span class="line">      <span class="keyword">case</span> STATEMENT:</span><br><span class="line">        delegate = <span class="keyword">new</span> <span class="title class_">SimpleStatementHandler</span>(executor, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> PREPARED:</span><br><span class="line">        delegate = <span class="keyword">new</span> <span class="title class_">PreparedStatementHandler</span>(executor, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> CALLABLE:</span><br><span class="line">        delegate = <span class="keyword">new</span> <span class="title class_">CallableStatementHandler</span>(executor, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ExecutorException</span>(<span class="string">&quot;Unknown statement type: &quot;</span> + ms.getStatementType());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Statement <span class="title function_">prepare</span><span class="params">(Connection connection, Integer transactionTimeout)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="comment">// 这里的delegate显然是对应上面switch里的PreparedStatementHandler</span></span><br><span class="line">    <span class="keyword">return</span> delegate.prepare(connection, transactionTimeout);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 找一下prepare方法</span></span><br><span class="line"><span class="comment">// 显然，和之前的Executor一样，又用到了适配器设计模式【StatementHandler的设计模式和Executor可以说一样，都是装饰器+适配器】</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PreparedStatementHandler</span> <span class="keyword">extends</span> <span class="title class_">BaseStatementHandler</span> &#123;</span><br><span class="line">  <span class="comment">// 这里只有update，query这些</span></span><br><span class="line">  <span class="comment">// 没有prepare，prepare在适配器BaseStatementHandler里</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">update</span><span class="params">(Statement statement)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="type">PreparedStatement</span> <span class="variable">ps</span> <span class="operator">=</span> (PreparedStatement) statement;</span><br><span class="line">    ps.execute();</span><br><span class="line">    <span class="type">int</span> <span class="variable">rows</span> <span class="operator">=</span> ps.getUpdateCount();</span><br><span class="line">    <span class="type">Object</span> <span class="variable">parameterObject</span> <span class="operator">=</span> boundSql.getParameterObject();</span><br><span class="line">    <span class="type">KeyGenerator</span> <span class="variable">keyGenerator</span> <span class="operator">=</span> mappedStatement.getKeyGenerator();</span><br><span class="line">    keyGenerator.processAfter(executor, mappedStatement, ps, parameterObject);</span><br><span class="line">    <span class="keyword">return</span> rows;</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="title function_">query</span><span class="params">(Statement statement, ResultHandler resultHandler)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="type">PreparedStatement</span> <span class="variable">ps</span> <span class="operator">=</span> (PreparedStatement) statement;</span><br><span class="line">    ps.execute();</span><br><span class="line">    <span class="keyword">return</span> resultSetHandler.&lt;E&gt; handleResultSets(ps);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseStatementHandler</span> <span class="keyword">implements</span> <span class="title class_">StatementHandler</span> &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="comment">// 准备Statement，给PreparedStatementHandler用</span></span><br><span class="line">  <span class="keyword">public</span> Statement <span class="title function_">prepare</span><span class="params">(Connection connection, Integer transactionTimeout)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    ErrorContext.instance().sql(boundSql.getSql());</span><br><span class="line">    <span class="type">Statement</span> <span class="variable">statement</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 给connection获取statement，最后返回statement</span></span><br><span class="line">      statement = instantiateStatement(connection);</span><br><span class="line">      setStatementTimeout(statement, transactionTimeout);</span><br><span class="line">      setFetchSize(statement);</span><br><span class="line">      <span class="keyword">return</span> statement;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">      closeStatement(statement);</span><br><span class="line">      <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      closeStatement(statement);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ExecutorException</span>(<span class="string">&quot;Error preparing statement.  Cause: &quot;</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="拦截器的使用"><a href="#拦截器的使用" class="headerlink" title="拦截器的使用"></a>拦截器的使用</h2><p>核心就是重写拦截器中的拦截方法【intercept】。执行完拦截之后，我可以放行；也可以有多个拦截器的存在，不放行，再执行下一个拦截器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 我们知道，拦截器可以拦截Executor和handler里的所有方法，那么我们通过下面这个注解指定拦截谁</span></span><br><span class="line"><span class="comment">// type：拦截的类型，你拦截的是Executor还是statementHandler还是什么</span></span><br><span class="line"><span class="comment">// method+args：拦截的方法【因为可能有重载，所以要带上参数】</span></span><br><span class="line"><span class="meta">@Intercepts(&#123;</span></span><br><span class="line"><span class="meta">        @Signature(type= Executor.class,method=&quot;query&quot;,args=&#123;MappedStatement.class,Object.class, RowBounds.class, ResultHandler.class&#125;),</span></span><br><span class="line"><span class="meta">        @Signature(type= Executor.class,method=&quot;update&quot;,args=&#123;MappedStatement.class,Object.class&#125;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyMybatisInterceptor</span> <span class="keyword">implements</span> <span class="title class_">Interceptor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String test;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(MyMybatisInterceptor.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  作用：执行的拦截功能 书写在这个方法中.</span></span><br><span class="line"><span class="comment">     *       放行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">            log.debug(<span class="string">&quot;----拦截器中的 intercept 方法执行------  &quot;</span>+test);</span><br><span class="line">        <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     *  把这个拦截器目标 传递给 下一个拦截器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">plugin</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Plugin.wrap(target,<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     *  获取拦截器相关参数的</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setProperties</span><span class="params">(Properties properties)</span> &#123;</span><br><span class="line">       <span class="built_in">this</span>.test = properties.getProperty(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="怎么拿SQL语句"><a href="#怎么拿SQL语句" class="headerlink" title="怎么拿SQL语句"></a>怎么拿SQL语句</h3><p>如果我们熟悉Mybatis暴露出来的方法，我们可以直接用，比如getBoundSql。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">  <span class="type">RoutingStatementHandler</span> <span class="variable">satementHandler</span> <span class="operator">=</span> (RoutingStatementHandler) invocation.getTarget();</span><br><span class="line">  <span class="type">BoundSql</span> <span class="variable">boundSql</span> <span class="operator">=</span> satementHandler.getBoundSql();</span><br><span class="line">  <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> boundSql.getSql();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此外，我们也可以通过MetaObject反射获取私有属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果我们想打破谁的封装，可以用MetaObject</span></span><br><span class="line"><span class="type">MetaObject</span> <span class="variable">metaObject</span> <span class="operator">=</span> SystemMetaObject.forObject(invocation);</span><br><span class="line"><span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> (String) metaObject.getValue(<span class="string">&quot;target.delegate.boundSql.sql&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>除了getValue，MetaObject还提供了很多操作</p>
<img src="https://raw.githubusercontent.com/cccccc96/cloudimg/main/image-20240806224447180.png" alt="image-20240806224447180" style="zoom:50%;" />

<h4 id=""><a href="#" class="headerlink" title=""></a></h4>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2022 - 2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">蔡正海</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  



  <script src="/js/third-party/fancybox.js"></script>



  





</body>
</html>
