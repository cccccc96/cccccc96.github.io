<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":true,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="czh的学习小站">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="czh的学习小站">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="蔡正海">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>czh的学习小站</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">czh的学习小站</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">自律</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="蔡正海"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">蔡正海</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">46</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/mybatis%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/mybatis6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/mybatis%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/mybatis6/" class="post-title-link" itemprop="url">【1开发】【Mybatis源码学习笔记】06 - 以拦截器应用为例</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/Mybatis%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Mybatis源码学习笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="拦截器应用"><a href="#拦截器应用" class="headerlink" title="拦截器应用"></a>拦截器应用</h1><p>实现一个分页拦截器，统一加分页</p>
<p>写了简单的测试用例，我们只需要拦截一下prepare，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="comment">//获得sql语句 拼接字符串 limit</span></span><br><span class="line">    <span class="type">MetaObject</span> <span class="variable">metaObject</span> <span class="operator">=</span> SystemMetaObject.forObject(invocation);</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> (String) metaObject.getValue(<span class="string">&quot;target.delegate.boundSql.sql&quot;</span>);</span><br><span class="line">  	<span class="type">String</span> <span class="variable">newsql</span> <span class="operator">=</span> sql + <span class="string">&quot; limit 0,3&quot;</span>;</span><br><span class="line">  	metaObject.setValue(<span class="string">&quot;target.delegate.boundSql.sql&quot;</span>,newSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="如何判定是否query是否需要分页"><a href="#如何判定是否query是否需要分页" class="headerlink" title="如何判定是否query是否需要分页"></a>如何判定是否query是否需要分页</h2><p>方案1:直接拦截注解配置为query方法</p>
<p>方案2:判定mapperstatement的id，比如我们可以限定id是否以query开头，是否以ByPage结尾，只有这样才会分页</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">MappedStatement</span> <span class="variable">mappedStatement</span> <span class="operator">=</span> (MappedStatement) metaObject.getValue(<span class="string">&quot;target.delegate.mappedStatement&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> mappedStatement.getId();</span><br><span class="line"><span class="keyword">if</span> (id.indexOf(queryMethodPrefix) != -<span class="number">1</span> &amp;&amp; id.endsWith(queryMethodSuffix))&#123;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="详细计算分页信息"><a href="#详细计算分页信息" class="headerlink" title="详细计算分页信息"></a>详细计算分页信息</h2><p>前端传过来了页号，每页显示多少数据是已知。</p>
<p>所以我们还需要先计算全表有多少条数据【sql语句替换成count(*)，并用connection执行】。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用count(*)获得全表有多少条数据，那么我们只需要做一下字符串替换</span></span><br><span class="line"><span class="comment">// 例如：select id,name from t_user where name = ?; 替换成 select count(*）from t_user where name = ?</span></span><br><span class="line"><span class="type">String</span> <span class="variable">countSql</span> <span class="operator">=</span> <span class="string">&quot;select count(*) &quot;</span> + sql.substring(sql.indexOf(<span class="string">&quot;from&quot;</span>));</span><br><span class="line"><span class="comment">//JDBC操作</span></span><br><span class="line"><span class="comment">//1 Connection【反射的方法里的参数】  PreapredStatement</span></span><br><span class="line"><span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> (Connection) invocation.getArgs()[<span class="number">0</span>];</span><br><span class="line"><span class="type">PreparedStatement</span> <span class="variable">preparedStatement</span> <span class="operator">=</span> conn.prepareStatement(countSql);</span><br><span class="line"><span class="type">ParameterHandler</span> <span class="variable">parameterHandler</span> <span class="operator">=</span> (ParameterHandler) metaObject.getValue(<span class="string">&quot;target.delegate.parameterHandler&quot;</span>);</span><br><span class="line">parameterHandler.setParameters(preparedStatement);</span><br><span class="line"><span class="type">ResultSet</span> <span class="variable">resultSet</span> <span class="operator">=</span> preparedStatement.executeQuery();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="怎么获得前端传来的页号信息"><a href="#怎么获得前端传来的页号信息" class="headerlink" title="怎么获得前端传来的页号信息"></a>怎么获得前端传来的页号信息</h2><p>使用TreadLocal存储</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/mybatis%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/mybatis7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/mybatis%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/mybatis7/" class="post-title-link" itemprop="url">【1开发】【Mybatis源码学习笔记】07 - 复盘</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/Mybatis%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Mybatis源码学习笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>SqlSessionFactory factory &#x3D; new SqlSessionFactoryBuilder().build(inputStream);<br>SqlSession sqlSession &#x3D; factory.openSession();<br>XxxDAO XxxDAO &#x3D; sqlSession.getMapper(XxxDAO.class);</p>
<p>根据这三行代码依次进行复盘：创建SqlSession工厂；工厂创建SqlSession；SqlSession动态代理创建接口实现类</p>
</blockquote>
<h1 id="1-构建SqlSessionFactory"><a href="#1-构建SqlSessionFactory" class="headerlink" title="1. 构建SqlSessionFactory"></a>1. 构建SqlSessionFactory</h1><blockquote>
<p>SqlSessionFactory factory &#x3D; new SqlSessionFactoryBuilder().build(inputStream);</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return new DefaultSqlSessionFactory(config);</span><br></pre></td></tr></table></figure>

<h2 id="1-1-XML解析"><a href="#1-1-XML解析" class="headerlink" title="1.1 XML解析"></a>1.1 XML解析</h2><p>使用工具<strong>XPathParser</strong>所有XML里的信息会被解析成一个个<strong>XNode</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//    &lt;users&gt;  </span></span><br><span class="line"><span class="comment">//       &lt;user id=&quot;1&quot;&gt;</span></span><br><span class="line"><span class="comment">//           &lt;name&gt;xiaohei&lt;/name&gt;</span></span><br><span class="line"><span class="comment">//           &lt;password&gt;2222&lt;/password&gt;</span></span><br><span class="line"><span class="comment">//      &lt;/user&gt;</span></span><br><span class="line"><span class="comment">//   &lt;/users&gt;</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XNode</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Node node;	</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String name;  <span class="comment">// &lt;users&gt;,&lt;name&gt;</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String body;  <span class="comment">// xiaohei,2222</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Properties attributes;  <span class="comment">// id=&quot;1&quot;</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Properties variables;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> XPathParser xpathParser;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-2-封装与配置相关的对象"><a href="#1-2-封装与配置相关的对象" class="headerlink" title="1.2 封装与配置相关的对象"></a>1.2 封装与配置相关的对象</h2><h3 id="1-2-1-对象1-Configuration"><a href="#1-2-1-对象1-Configuration" class="headerlink" title="1.2.1 对象1-Configuration"></a>1.2.1 对象1-Configuration</h3><p>Configuration可以说是包含了MyBatis需要的所有信息，其中比较重要的有</p>
<ul>
<li>environment：JDBC相关参数的配置</li>
<li>interceptorChain：拦截器</li>
<li>mappedStatemnts：应用中所创建的MappedStamenet对象</li>
<li>caches：缓存【感觉缓存生产环境用不上？】</li>
</ul>
<img src="https://raw.githubusercontent.com/cccccc96/cloudimg/main/image-20240808212802383.png" alt="image-20240808212802383" style="zoom: 33%;" />

<p>工厂的作用，创建Mybatis中核心的几个功能对象：</p>
<ul>
<li>Executor</li>
<li>StatementHandler</li>
</ul>
<p><img src="https://raw.githubusercontent.com/cccccc96/cloudimg/main/image-20240808214615129.png" alt="image-20240808214615129"></p>
<h3 id="1-2-2-对象2-MappedStatemtnt"><a href="#1-2-2-对象2-MappedStatemtnt" class="headerlink" title="1.2.2 对象2-MappedStatemtnt"></a>1.2.2 对象2-MappedStatemtnt</h3><p>对应的就是一个个配置标签&lt;Select；&lt;Insert</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">MappedStatement</span> &#123;</span><br><span class="line">  <span class="comment">// 标签中的各种属性</span></span><br><span class="line">  <span class="keyword">private</span> String id;</span><br><span class="line">  <span class="comment">// 1.普通，没有预编译效率太低；2.prepared，预编译阶段；3.callable，用于存储过程</span></span><br><span class="line">  <span class="keyword">private</span> StatementType statementType;【默认是prepared】</span><br><span class="line">  <span class="keyword">private</span> ResultSetType resultSetType;</span><br><span class="line">  <span class="comment">// Configuration【mapper可以拿到config，config也可以拿到mapper】</span></span><br><span class="line">  <span class="keyword">private</span> Configuration configuration;</span><br><span class="line">  <span class="comment">// 缓存</span></span><br><span class="line">  <span class="keyword">private</span> Cache cache;</span><br><span class="line">  <span class="comment">// 真正SQL语句的封装</span></span><br><span class="line">  <span class="keyword">public</span> BoundSql <span class="title function_">getBoundSql</span><span class="params">()</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="2-SqlSessionFactory创建"><a href="#2-SqlSessionFactory创建" class="headerlink" title="2. SqlSessionFactory创建"></a>2. SqlSessionFactory创建</h1><blockquote>
<p>SqlSession sqlSession &#x3D; factory.openSession();</p>
</blockquote>
<p>实现类 DefaultSqlSession，创建SqlSession对象</p>
<h1 id="3-SqlSession动态代理创建接口实现类"><a href="#3-SqlSession动态代理创建接口实现类" class="headerlink" title="3. SqlSession动态代理创建接口实现类"></a>3. SqlSession动态代理创建接口实现类</h1><blockquote>
<p>XxxDAO XxxDAO &#x3D; sqlSession.getMapper(XxxDAO.class);</p>
</blockquote>
<p>基于DAO接口 通过动态代理技术 获得接口的实现类</p>
<h2 id="3-1-通过什么-完成-接口实现类的创建"><a href="#3-1-通过什么-完成-接口实现类的创建" class="headerlink" title="3.1 通过什么 完成 接口实现类的创建"></a>3.1 通过什么 完成 接口实现类的创建</h2><ol>
<li>MapperProxyFactory</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">protected T newInstance(MapperProxy&lt;T&gt; mapperProxy) &#123;</span><br><span class="line">  return (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), new Class[] &#123; mapperInterface &#125;, mapperProxy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>MapperProxy</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MapperProxy</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span>, Serializable &#123;</span><br><span class="line">  <span class="comment">// sqlSession和Dao接口</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> SqlSession sqlSession;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;T&gt; mapperInterface;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="comment">// 先判断是否是Object类型，比如要执行的是toString这种方法，原样运行</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (Object.class.equals(method.getDeclaringClass())) &#123;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(<span class="built_in">this</span>, args);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isDefaultMethod(method)) &#123;</span><br><span class="line">        <span class="keyword">return</span> invokeDefaultMethod(proxy, method, args);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">      <span class="keyword">throw</span> ExceptionUtil.unwrapThrowable(t);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 原有DAO接口的一个封装</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">MapperMethod</span> <span class="variable">mapperMethod</span> <span class="operator">=</span> cachedMapperMethod(method);</span><br><span class="line">    <span class="comment">// 除了Object之外的，我们才应该执行sqlSession对应的方法</span></span><br><span class="line">    <span class="keyword">return</span> mapperMethod.execute(sqlSession, args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用流程</p>
<ol>
<li>SqlSession.getMapper</li>
<li>Configruation.getMapper()</li>
<li>mapperRegistry.getMapper</li>
<li>mapperProxyFactory.newInstance(sqlSession)</li>
<li>Proxy.newProxyInstace()</li>
</ol>
<h2 id="3-2-创建了接口的实现类，里面代码如何运行"><a href="#3-2-创建了接口的实现类，里面代码如何运行" class="headerlink" title="3.2 创建了接口的实现类，里面代码如何运行"></a>3.2 创建了接口的实现类，里面代码如何运行</h2><p>SqlSession.selectList()<br>            .selectOne()<br>            .insert<br>            .update()</p>
<h2 id="3-3-再底层一些，SqlSession-selectList-由谁实现"><a href="#3-3-再底层一些，SqlSession-selectList-由谁实现" class="headerlink" title="3.3 再底层一些，SqlSession.selectList()由谁实现"></a>3.3 再底层一些，SqlSession.selectList()由谁实现</h2><h3 id="3-3-1-Executor"><a href="#3-3-1-Executor" class="headerlink" title="3.3.1 Executor"></a>3.3.1 Executor</h3><p>Executor【Mybatis核心执行器】</p>
<ol>
<li>对数据库操作 CRUD </li>
<li>事务 </li>
<li>缓存</li>
</ol>
<p>这里运用了两个设计模式</p>
<ul>
<li>适配器【BaseExecutor】：解决通用逻辑</li>
<li>装饰器模式【CachingExecutor】：缓存</li>
</ul>
<p><img src="https://raw.githubusercontent.com/cccccc96/cloudimg/main/image-20240808222627161.png" alt="image-20240808222627161"></p>
<h3 id="3-3-2-StatmentHandler"><a href="#3-3-2-StatmentHandler" class="headerlink" title="3.3.2 StatmentHandler"></a>3.3.2 StatmentHandler</h3><p>底层封装 Statement —&gt; prepare()</p>
<p>这里运用了两个设计模式</p>
<ul>
<li>适配器【Base】：解决通用逻辑</li>
<li>装饰器模式【Routing】：进行statement类型的区分，进而调用具体的statementHandler</li>
</ul>
<p><img src="https://raw.githubusercontent.com/cccccc96/cloudimg/main/image-20240808223335036.png" alt="image-20240808223335036"></p>
<h3 id="3-3-3-ParameterHandler"><a href="#3-3-3-ParameterHandler" class="headerlink" title="3.3.3 ParameterHandler"></a>3.3.3 ParameterHandler</h3><p>进行jdbc prepareStatement ? 替换 参数替换</p>
<h3 id="3-3-4-。。。。。。还有很多"><a href="#3-3-4-。。。。。。还有很多" class="headerlink" title="3.3.4 。。。。。。还有很多"></a>3.3.4 。。。。。。还有很多</h3>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/spring%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/spring1-%E5%B7%A5%E5%8E%82/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/spring%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/spring1-%E5%B7%A5%E5%8E%82/" class="post-title-link" itemprop="url">【1开发】【spring入门学习笔记】01-工厂</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/spring%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">spring入门学习笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="1-为什么要有这个工厂呢"><a href="#1-为什么要有这个工厂呢" class="headerlink" title="1. 为什么要有这个工厂呢"></a>1. 为什么要有这个工厂呢</h1><h2 id="工厂设计模式的好处（解耦合）"><a href="#工厂设计模式的好处（解耦合）" class="headerlink" title="工厂设计模式的好处（解耦合）"></a>工厂设计模式的好处（解耦合）</h2><p>我们不希望这种new的出现【开闭原则（打开扩展，少做修改）】</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 硬编码在程序中，会影响调用者</span></span><br><span class="line"><span class="type">A</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AImpl</span>()</span><br></pre></td></tr></table></figure>

<p>我们可以自己实现一个<strong>简单工厂</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">A <span class="title function_">getA</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="comment">//反射创建对象</span></span><br><span class="line">  <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName();</span><br><span class="line">  <span class="keyword">return</span> clazz.newInstance();</span><br><span class="line">&#125;</span><br><span class="line">B <span class="title function_">getB</span><span class="params">()</span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>但这样太<strong>冗余</strong>了，我们可以完善成一个<strong>通用工厂</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Object <span class="title function_">getBean</span><span class="params">(String key)</span>&#123;</span><br><span class="line">  <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(env.getProperty(key));</span><br><span class="line">  res = clazz.newInstance();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="2-ApplicationContext"><a href="#2-ApplicationContext" class="headerlink" title="2. ApplicationContext"></a>2. ApplicationContext</h1><p>ApplicationContext是spring提供<strong>创建对象的工厂</strong></p>
<ul>
<li><strong>接口类型</strong>（屏蔽了实现的差异）<ul>
<li>非web环境 ： ClassPathXmlApplicationContext</li>
<li>web环境  ：  XmlWebApplicationContext</li>
</ul>
</li>
<li><strong>重量级资源</strong>（占用大量内存）<ul>
<li>一个应用只有一个</li>
<li>线程安全</li>
</ul>
</li>
</ul>
<p>简单用一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ApplicationContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;/applicationContext.xml&quot;</span>);</span><br><span class="line"><span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> (Person)ctx.getBean(<span class="string">&quot;person&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>xml细节暂时就不看了，都没用过</p>
<p>ApplicationContext底层实现<strong>简易原理</strong></p>
<ul>
<li>通过工厂读取配置文件</li>
<li>反射创建对象</li>
</ul>
<blockquote>
<p>是否是所有对象都交给spring工厂？</p>
<p>大部分是，但实体对象这种当然不会交给spring工厂创建。</p>
</blockquote>
<h1 id="3-注入"><a href="#3-注入" class="headerlink" title="3. 注入"></a>3. 注入</h1><h2 id="什么是注入？"><a href="#什么是注入？" class="headerlink" title="什么是注入？"></a><strong>什么是注入？</strong></h2><p>通过Spring工厂及配置文件，为成员变量赋值。</p>
<h2 id="为什么需要注入？"><a href="#为什么需要注入？" class="headerlink" title="为什么需要注入？"></a><strong>为什么需要注入？</strong></h2><p>通过set方法，为成员变量赋值，存在<strong>耦合</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ClassPathXmlApplicationContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line"><span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> (Person) ctx.getBean(<span class="string">&quot;person&quot;</span>);</span><br><span class="line"><span class="comment">//通过代码为变量赋值, 存在耦合, 如果以后想修改变量的值, 需要修改代码, 重新编译</span></span><br><span class="line">person.setName(<span class="string">&quot;czh&quot;</span>);</span><br><span class="line">person.setAge(<span class="number">16</span>);</span><br></pre></td></tr></table></figure>

<p>因此，我们将其改进成<strong>配置文件</strong>的方式来对其进行注入。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//配置文件</span></span><br><span class="line">&lt;bean id=<span class="string">&quot;person1&quot;</span> name=<span class="string">&quot;p&quot;</span> class=<span class="string">&quot;com.yuziyan.basic.Person&quot;</span>&gt;</span><br><span class="line">    &lt;property name=<span class="string">&quot;name&quot;</span>&gt;</span><br><span class="line">        &lt;value&gt;czh&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property name=<span class="string">&quot;age&quot;</span>&gt;</span><br><span class="line">        &lt;value&gt;<span class="number">200</span>&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">&lt;/bean&gt;</span><br><span class="line"></span><br><span class="line"><span class="type">ClassPathXmlApplicationContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line"><span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> (Person) ctx.getBean(<span class="string">&quot;person&quot;</span>);</span><br></pre></td></tr></table></figure>

<h1 id="4-控制反转（IOC）-依赖注入"><a href="#4-控制反转（IOC）-依赖注入" class="headerlink" title="4. 控制反转（IOC）&#x2F; 依赖注入"></a>4. 控制反转（IOC）&#x2F; 依赖注入</h1><h2 id="什么是控制"><a href="#什么是控制" class="headerlink" title="什么是控制"></a>什么是控制</h2><p>控制：对于成员变量的控制权</p>
<p>控制权由你这个代码来控制：new A()【耦合】</p>
<h2 id="什么是反转"><a href="#什么是反转" class="headerlink" title="什么是反转"></a>什么是反转</h2><p>控制权反转：配置文件+工厂来完成</p>
<p>好处：接耦合</p>
<p>底层实现：工厂</p>
<h1 id="5-控制Spring工厂创建对象的次数"><a href="#5-控制Spring工厂创建对象的次数" class="headerlink" title="5. 控制Spring工厂创建对象的次数"></a>5. 控制Spring工厂创建对象的次数</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">singleton：只会创建一次简单对象</span><br><span class="line">prototype：每一次都会创建新的对象</span><br></pre></td></tr></table></figure>

<p>为什么要控制对象对象创建的次数？</p>
<ul>
<li><strong>减少不必要的内存浪费</strong></li>
<li>什么样的对象只<strong>创建一次</strong>？（SqlSessionFactory，DAO，Service）</li>
<li>什么养的对象<strong>每次创建新的</strong>？（Connection，SqlSession，Session）</li>
</ul>
<h1 id="6-对象的生命周期"><a href="#6-对象的生命周期" class="headerlink" title="6. 对象的生命周期"></a>6. 对象的生命周期</h1><p>由<strong>Spring负责对象的创建、存活、销毁</strong>（而非我们去控制 JVM GC）</p>
<h2 id="生命周期三个阶段"><a href="#生命周期三个阶段" class="headerlink" title="生命周期三个阶段"></a>生命周期三个阶段</h2><ul>
<li><p><strong>创建阶段</strong>（何时创建对象）</p>
<ul>
<li>singleton：工厂创建的同时，创建对象</li>
<li>prototype：获取对象的时候（ctx.getBean），创建对象</li>
</ul>
</li>
<li><p><strong>初始化阶段</strong>（spring工厂创建完对象之后，调用这个初始化方法），可以用如下三种方法实现</p>
<ul>
<li><p>实现InitializingBean接口</p>
</li>
<li><pre><code class="java">&lt;bean id=&quot;A&quot; class=&quot;xxx.A&quot; init-method=&quot;myInit&quot;/&gt;
Class A&#123;
    public void myInit()&#123;&#125;
&#125;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  * （springboot）@PostConstruct</span><br><span class="line"></span><br><span class="line">* **销毁阶段**（spring在销毁对象【ctx.close】前，会调用对象的销毁方法）</span><br><span class="line"></span><br><span class="line">  * 实现DisposableBean</span><br><span class="line"></span><br><span class="line">  * ```</span><br><span class="line">    &lt;bean id=&quot;&quot; class=&quot;&quot; init-method=&quot;&quot; destroy-method=&quot;myDestroy&quot;/&gt;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>（springboot）@Pre Destroy</p>
</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/spring%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/spring2-AOP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/spring%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/spring2-AOP/" class="post-title-link" itemprop="url">【1开发】【spring入门学习笔记】02-AOP</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/spring%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">spring入门学习笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="1-静态代理设计模式"><a href="#1-静态代理设计模式" class="headerlink" title="1. 静态代理设计模式"></a>1. 静态代理设计模式</h1><h2 id="为什么需要代理设计模式"><a href="#为什么需要代理设计模式" class="headerlink" title="为什么需要代理设计模式"></a>为什么需要代理设计模式</h2><p>一个Service包含了什么？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Service层中 = 核心功能(几十行 上百代码) + 额外功能(附加功能)</span><br><span class="line">1. 核心功能</span><br><span class="line">   业务运算</span><br><span class="line">   DAO调用</span><br><span class="line">2. 额外功能(事务、日志、性能...)</span><br><span class="line">   1. 不属于业务</span><br><span class="line">   2. 可有可无</span><br><span class="line">   3. 代码量很小 </span><br></pre></td></tr></table></figure>

<p><strong>那么额外功能，应不应该写在Service层中？</strong>（不应该，让它写在代理类）</p>
<p>所以，我们可以引入一个<strong>代理类</strong>。</p>
<p><strong>代理三要素：原始功能，额外功能，代理对象和原始对象实现相同的接口</strong></p>
<h2 id="代理设计模式"><a href="#代理设计模式" class="headerlink" title="代理设计模式"></a>代理设计模式</h2><p>通过代理类，为原始类增加额外的功能。（<strong>利于原始类的维护</strong>）</p>
<p>如何实现<strong>一个简单的静态代理</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">代理类 = 实现和目标类相同的接口 + 在同名方法中添加额外功能 + 调用原始类同名方法</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span>&#123;</span><br><span class="line">	m1</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span>&#123;</span><br><span class="line">	m1 ---&gt; 业务运算 DAO调用</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserServiceProxy</span> <span class="keyword">implements</span> <span class="title class_">UserService</span>&#123;</span><br><span class="line">	<span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserServiceImpl</span>()</span><br><span class="line">	m1()&#123;</span><br><span class="line">		额外功能();</span><br><span class="line">    userService.m1();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>静态代理的缺点</p>
<ul>
<li>静态类文件数量过多，一千个Service就有一千个代理类</li>
<li>额外功能维护性多</li>
</ul>
<h1 id="2-Spring动态代理开发"><a href="#2-Spring动态代理开发" class="headerlink" title="2. Spring动态代理开发"></a>2. Spring动态代理开发</h1><p>通过代理类，为原始类增加额外的功能。（<strong>利于原始类的维护</strong>）</p>
<h2 id="通过MethodBeforeAdvice定义额外功能（Before）"><a href="#通过MethodBeforeAdvice定义额外功能（Before）" class="headerlink" title="通过MethodBeforeAdvice定义额外功能（Before）"></a>通过MethodBeforeAdvice定义额外功能（Before）</h2><ol>
<li>创建原始对象(目标对象)</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;UserServiceImpl.register&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;userServiceImpl&quot; class=&quot;com.yuziyan.factory.UserServiceImpl&quot;&gt;&lt;/bean&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>定义额外功能（实现MethodBeforeAdvice接口）</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Before</span> <span class="keyword">implements</span> <span class="title class_">MethodBeforeAdvice</span> &#123;</span><br><span class="line">	<span class="comment">//作用：给原始方法添加额外功能</span></span><br><span class="line">    <span class="comment">//注意：会在原始方法运行之前运行此方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">(Method method, Object[] args, Object target)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;-----method before advice log------&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;before&quot; class=&quot;com.yuziyan.dynamic.Before&quot;/&gt;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>定义切入点</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 切入点：额外功能加入的位置</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 目的：由程序员根据自己的需要，决定额外功能加入给那个原始方法</span><br><span class="line">register()</span><br><span class="line">login()</span><br><span class="line"></span><br><span class="line">简单的测试：所有方法都做为切入点，都加入额外的功能。</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;aop:config&gt;</span><br><span class="line">   &lt;aop:pointcut id=<span class="string">&quot;pc&quot;</span> expression=<span class="string">&quot;execution(* *(..))&quot;</span>/&gt;</span><br><span class="line">&lt;/aop:config&gt;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>组装</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 组装切入点与额外功能 --&gt;</span><br><span class="line">&lt;aop:advisor advice-ref=&quot;before&quot; pointcut-ref=&quot;pc&quot;/&gt;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>调用(<strong>注意！！，这时候拿到的Bean是代理对象</strong>)</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UserService userService=(UserService)ctx.getBean(&quot;userService&quot;);</span><br><span class="line">userService.login(&quot;&quot;)</span><br></pre></td></tr></table></figure>

<h2 id="通过MethodInterceptor定义额外功能（Around）"><a href="#通过MethodInterceptor定义额外功能（Around）" class="headerlink" title="通过MethodInterceptor定义额外功能（Around）"></a>通过MethodInterceptor定义额外功能（Around）</h2><p>其他1，3，4，5步骤都一致，第2步为MethodInterceptor（例如实现一个事务）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Around</span> <span class="keyword">implements</span> <span class="title class_">MethodInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(MethodInvocation invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        tx.begin</span><br><span class="line">        <span class="type">Object</span> <span class="variable">ret</span> <span class="operator">=</span> invocation.proceed();</span><br><span class="line">        tx.commit</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="3-spring动态代理类是通过什么实现的"><a href="#3-spring动态代理类是通过什么实现的" class="headerlink" title="3. spring动态代理类是通过什么实现的"></a>3. spring动态代理类是通过什么实现的</h1><p>Spring框架在运行时，通过<strong>动态字节码</strong>技术，在<strong>JVM</strong>创建的，运行在JVM内部，等程序结束后就消失了。</p>
<p>什么是动态字节码？</p>
<ul>
<li>正常Java运行一个类，JVM运行这个类的字节码<ul>
<li>.java文件编译成.class文件</li>
<li>类加载.class文件</li>
</ul>
</li>
<li><strong>动态字节码</strong><ul>
<li>不需要.java文件，不需要.class文件</li>
<li>通过第三方框架（ASM，Cglib），直接在虚拟机中生成字节码</li>
</ul>
</li>
</ul>
<h1 id="4-如何定义切入点"><a href="#4-如何定义切入点" class="headerlink" title="4. 如何定义切入点"></a>4. 如何定义切入点</h1><p><strong>切入点表达式</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">*  *(..)  --&gt; 所有方法</span><br><span class="line"></span><br><span class="line">* ---&gt; 修饰符 返回值</span><br><span class="line">* ---&gt; 方法名</span><br><span class="line">()---&gt; 参数表</span><br><span class="line">..---&gt; 对于参数没有要求 (0个或多个)</span><br></pre></td></tr></table></figure>

<p><strong>切入点函数</strong>（除了annotation还有很多）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@annotation(com.czh.Log)</span><br></pre></td></tr></table></figure>

<h1 id="5-AOP编程"><a href="#5-AOP编程" class="headerlink" title="5. AOP编程"></a>5. AOP编程</h1><h2 id="AOP概念"><a href="#AOP概念" class="headerlink" title="AOP概念"></a>AOP概念</h2><p><strong>切面 &#x3D; 切入点 + 额外功能</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">AOP (Aspect Oriented Programing)   面向切面编程 = Spring动态代理开发</span><br><span class="line">以切面为基本单位的程序开发，通过切面间的彼此协同，相互调用，完成程序的构建</span><br><span class="line">切面 = 切入点 + 额外功能</span><br><span class="line"></span><br><span class="line">OOP (Object Oriented Programing)   面向对象编程 Java</span><br><span class="line">以对象为基本单位的程序开发，通过对象间的彼此协同，相互调用，完成程序的构建</span><br><span class="line"></span><br><span class="line">POP (Procedure Oriented Programing) 面向过程(方法、函数)编程 C </span><br><span class="line">以过程为基本单位的程序开发，通过过程间的彼此协同，相互调用，完成程序的构建</span><br></pre></td></tr></table></figure>

<p><strong>步骤</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">原始对象</span><br><span class="line">额外功能 (MethodInterceptor)</span><br><span class="line">切入点</span><br><span class="line">组装切面 (额外功能+切入点)</span><br></pre></td></tr></table></figure>

<h1 id="5-spring动态代理类底层实现"><a href="#5-spring动态代理类底层实现" class="headerlink" title="5. spring动态代理类底层实现"></a>5. spring动态代理类底层实现</h1><h2 id="核心问题"><a href="#核心问题" class="headerlink" title="核心问题"></a>核心问题</h2><ol>
<li>AOP如何创建动态代理类（动态字节码技术）</li>
<li>spring工厂如何加工创建代理对象（因为getbean拿到的实际上是代理对象）</li>
</ol>
<h2 id="动态代理类的创建"><a href="#动态代理类的创建" class="headerlink" title="动态代理类的创建"></a>动态代理类的创建</h2><h3 id="方式1-–-JDK的动态代理（非AOP实现方法）【限制：必须有接口】"><a href="#方式1-–-JDK的动态代理（非AOP实现方法）【限制：必须有接口】" class="headerlink" title="方式1 – JDK的动态代理（非AOP实现方法）【限制：必须有接口】"></a>方式1 – JDK的动态代理（非AOP实现方法）【限制：必须有接口】</h3><p><strong>Proxy.newProxyInstance()</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Proxy.newProxyInstance(classloader,interfaces,invocationhandler)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>invocationhandler</strong>：提供了额外功能</li>
<li>interfaces：实现的相同接口</li>
<li>classloader（类加载器）：<ul>
<li>普通的类加载过程<ul>
<li>把对应的字节码.class文件加载JVM</li>
<li>在JVM创建类的Class对象</li>
<li>最后就可以new这个对象了</li>
</ul>
</li>
<li><strong>动态代理的类加载过程</strong><ul>
<li>没有.java文件，没有.class文件</li>
<li><strong>借用一个Classloader</strong></li>
<li>直接在JVM里<strong>动态创建字节码class对象</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="方式2-–-动态字节码CGlib（AOP实现方法）"><a href="#方式2-–-动态字节码CGlib（AOP实现方法）" class="headerlink" title="方式2 – 动态字节码CGlib（AOP实现方法）"></a>方式2 – 动态字节码CGlib（AOP实现方法）</h3><p>【不用实现相同接口，通过继承来做】</p>
<p>Enhancer()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Enhancer</span> <span class="variable">enhancer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Enhancer</span>();</span><br><span class="line">enhancer.setClassLoader(TestCGlibProxy.class.getClassLoader());</span><br><span class="line">enhancer.setSuperclass(userService.getClass());</span><br><span class="line">enhancer.setCallback(<span class="keyword">new</span> <span class="title class_">MethodInterceptor</span>() &#123;&#125;);</span><br><span class="line"><span class="type">UserServiceImpl</span> <span class="variable">service</span> <span class="operator">=</span> (UserServiceImpl) enhancer.create();</span><br></pre></td></tr></table></figure>

<h3 id="方式1-vs-方式2"><a href="#方式1-vs-方式2" class="headerlink" title="方式1 vs 方式2"></a>方式1 vs 方式2</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. JDK动态代理   Proxy.newProxyInstance()  通过目标类实现的接口创建代理类 </span><br><span class="line">2. Cglib动态代理 Enhancer                  通过继承目标类创建代理类 </span><br></pre></td></tr></table></figure>

<h2 id="Spring工厂何时创建代理对象"><a href="#Spring工厂何时创建代理对象" class="headerlink" title="Spring工厂何时创建代理对象"></a>Spring工厂何时创建代理对象</h2><p>模拟spring工厂创建代理对象【Bean初始化阶段，BeanPostProcessor】</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProxyBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">invocation</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvocationHandler</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;----------- 模拟Spring返回代理对象的方式 log -----------&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="type">Object</span> <span class="variable">ret</span> <span class="operator">=</span> method.invoke(bean, args);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(ProxyBeanPostProcessor.class.getClassLoader(), bean.getClass().getInterfaces(), invocation);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="6-基于注解的AOP编程（AspectJ）"><a href="#6-基于注解的AOP编程（AspectJ）" class="headerlink" title="6. 基于注解的AOP编程（AspectJ）"></a>6. 基于注解的AOP编程（AspectJ）</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;execution(* login(..))&quot;)</span><span class="comment">//组装了切入点和额外功能</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">around</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">//额外功能：</span></span><br><span class="line">        System.out.println(<span class="string">&quot;--------- 基于注解的AOP编程 log --------&quot;</span>);</span><br><span class="line">        <span class="comment">//原始方法执行：</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">ret</span> <span class="operator">=</span> joinPoint.proceed();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="7-AOP阶段知识总结"><a href="#7-AOP阶段知识总结" class="headerlink" title="7 AOP阶段知识总结"></a>7 AOP阶段知识总结</h1><p><img src="https://raw.githubusercontent.com/cccccc96/cloudimg/main/68747470733a2f2f692e6c6f6c692e6e65742f323032302f31302f30382f414261316632504c777a517353464f2e706e67.png" alt="image-20200503162625116"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/spring%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/spring3-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E4%BA%8B%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/spring%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/spring3-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E4%BA%8B%E5%8A%A1/" class="post-title-link" itemprop="url">【1开发】【spring入门学习笔记】03-数据库事务（Mybatis）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/spring%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">spring入门学习笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="1-事务"><a href="#1-事务" class="headerlink" title="1. 事务"></a>1. 事务</h1><h2 id="什么是事务"><a href="#什么是事务" class="headerlink" title="什么是事务"></a>什么是事务</h2><p>ACID（常规概念，跳过）</p>
<h2 id="如何控制事务"><a href="#如何控制事务" class="headerlink" title="如何控制事务"></a>如何控制事务</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sqlSession(Connection).commit();</span><br><span class="line">sqlSession(Connection).rollback();</span><br></pre></td></tr></table></figure>

<p>结论：控制事务的底层，<strong>都是connection对象完成的</strong></p>
<h2 id="spring控制事务的基本流程（AOP）"><a href="#spring控制事务的基本流程（AOP）" class="headerlink" title="spring控制事务的基本流程（AOP）"></a>spring控制事务的基本流程（AOP）</h2><p><strong>spring是通过AOP来进行事务开发的</strong></p>
<ol>
<li><p>原始对象（业务处理+DAO调用）</p>
</li>
<li><p>额外功能</p>
<ol>
<li><pre><code class="java">假如我们自己实现一下:
1. MethodInterceptor
   public Object invoke(MethodInvocation invocation)&#123;
         //原理：
      try&#123;
        Connection.setAutoCommit(false);
        Object ret = invocation.proceed();
        Connection.commit();
      &#125;catch(Exception e)&#123;
        Connection.rollback();
      &#125;
        return ret;
   &#125;
2. @Aspect
   @Around 
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   2. 当然，spring帮我们封装好了（DataSourceTransactionManager）</span><br><span class="line"></span><br><span class="line">3. 切入点（@Transaction）</span><br><span class="line"></span><br><span class="line"># 2. spring事务属性</span><br><span class="line"></span><br><span class="line">## 事务属性有哪些</span><br><span class="line"></span><br><span class="line">1. 隔离属性</span><br><span class="line">2. 传播属性</span><br><span class="line">3. 只读属性</span><br><span class="line">4. 超时属性</span><br><span class="line">5. 异常属性 </span><br><span class="line"></span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ol>
</li>
</ol>
<p>@Transactional(isloation&#x3D;,propagation&#x3D;,readOnly&#x3D;,timeout&#x3D;,rollbackFor&#x3D;,noRollbackFor&#x3D;,)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 属性1 隔离属性</span><br><span class="line"></span><br><span class="line">隔离属性涉及到的问题（也就是mysql里经常看到的那三个）</span><br><span class="line"></span><br><span class="line">**脏读：**</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>一个事务，读取了另一个事务中没有提交的数据<br>@Transactional(isolation&#x3D;Isolation.READ_COMMITTED)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**不可重复读**（MySQL默认）</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>一个事务中，多次读取相同的数据，但是读取结果不一样。<br>@Transactional(isolation&#x3D;Isolation.REPEATABLE_READ)<br>本质： 一把行锁（MVCC）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**幻影读**</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>读到了之前没有的数据<br>解决方案 @Transactional(isolation&#x3D;Isolation.SERIALIZABLE)<br>本质：表锁 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 属性2 传播属性</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>大的事务中，包含了若干个小的事务。导致外部大的事务，丧失了事务的原子性。</p>
<pre><code>
* **REQUIRED**【增删改】【默认】
  * 把子事务融合到外部大事务中
* **SUPPORTS**【查】
  * 把子事务融合到外部大事务中
  * 特别地，如果它是最外部大的事务，它不开启事务

### 属性3、4、5 只读属性、超时属性、异常属性

只读属性：针对于只进行查询操作的业务方法，可以加入只读属性，提供运行效率

超时属性：事务等待的最长时间

异常属性：不同异常采用的回滚策略


</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/spring%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/spring4-%E6%B3%A8%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/spring%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/spring4-%E6%B3%A8%E8%A7%A3/" class="post-title-link" itemprop="url">【1开发】【spring入门学习笔记】04-注解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/spring%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">spring入门学习笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="1-注解的作用"><a href="#1-注解的作用" class="headerlink" title="1. 注解的作用"></a>1. 注解的作用</h1><ul>
<li>替换XML这种配置形式，简化配置（例如@Component）</li>
<li>替换接口，实现调用双方的契约性（@Around）</li>
</ul>
<h1 id="2-Spring的几个基础注解"><a href="#2-Spring的几个基础注解" class="headerlink" title="2. Spring的几个基础注解"></a>2. Spring的几个基础注解</h1><h2 id="2-1-对象创建相关注解"><a href="#2-1-对象创建相关注解" class="headerlink" title="2.1 对象创建相关注解"></a>2.1 对象创建相关注解</h2><p><strong>@Component</strong>：替换原有spring配置文件中的bean标签 </p>
<p>如果想指定工厂创建对象的id值：【@Component(“u”)】</p>
<p><strong>衍生注解</strong>：@Repository ，@Service，@Controller </p>
<p><strong>控制对象的创建次数</strong>：@Scope（singleton|prototype）</p>
<p><strong>延迟创建单例对象</strong>：@Lazy</p>
<p><strong>生命周期创建</strong>：初始化相关方法【@PostConstruct】，销毁前方法【@PreDestroy】</p>
<h2 id="2-2-注入相关注解"><a href="#2-2-注入相关注解" class="headerlink" title="2.2 注入相关注解"></a>2.2 注入相关注解</h2><p>用户自定义类型**@Autowired<strong>，Autowired注解</strong>基于类型**进行注入，必须与目标成员变量类型相同或者是其子类。</p>
<p>获取属性值，@Value</p>
<h2 id="2-3-ComponentScan注解"><a href="#2-3-ComponentScan注解" class="headerlink" title="2.3 @ComponentScan注解"></a>2.3 @ComponentScan注解</h2><p>目的：进行相关注解的扫描 （@Component @Value @Autowired . . .)</p>
<h1 id="3-Spring的高级注解"><a href="#3-Spring的高级注解" class="headerlink" title="3. Spring的高级注解"></a>3. Spring的高级注解</h1><h2 id="3-1-配置Bean"><a href="#3-1-配置Bean" class="headerlink" title="3.1 配置Bean"></a>3.1 配置Bean</h2><p>回忆以前用xml是如何做的，new  ClassPathXmlApplicationContext()</p>
<p>现在，我们可以用**@Configuration和AnnotationConfigApplicationContext**来配置Bean。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class AppConfig&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">ApplicationContext ctx = new AnnotationConfigApplicationContext(AppConfig.class);</span><br></pre></td></tr></table></figure>

<h2 id="3-2-Bean注解在配置bean"><a href="#3-2-Bean注解在配置bean" class="headerlink" title="3.2 @Bean注解在配置bean"></a>3.2 @Bean注解在配置bean</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span>&#123;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> User【对象类型class】 user【id】()&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 我们用这种方式替换了&lt;bean id=&quot;user&quot; class=&quot;xxx.User&quot;&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="3-3-配置Bean底层实现原理"><a href="#3-3-配置Bean底层实现原理" class="headerlink" title="3.3 配置Bean底层实现原理"></a>3.3 配置Bean底层实现原理</h2><p>Spring在配置Bean中加入了@Configuration注解后，底层就会通过Cglib的代理方式，来进行对象相关的配置、处理</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/bagu/IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/bagu/IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/" class="post-title-link" itemprop="url">【1开发】【八股】IO多路复用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E5%85%AB%E8%82%A1/" itemprop="url" rel="index"><span itemprop="name">八股</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="IO多路复用"><a href="#IO多路复用" class="headerlink" title="IO多路复用"></a>IO多路复用</h2><h3 id="TCP的最基本的Socket连接编程步骤"><a href="#TCP的最基本的Socket连接编程步骤" class="headerlink" title="TCP的最基本的Socket连接编程步骤"></a>TCP的最基本的Socket连接编程步骤</h3><ol>
<li>服务端调用Socket（）和bind（）函数<ol>
<li>为Socket绑定IP地址和端口</li>
<li>为什么绑端口：通过TCP报文中的端口号，找到应用程序</li>
<li>为什么绑IP：一台机器有多个网卡，对应多个IP地址</li>
</ol>
</li>
<li>服务端listen（）函数，进入监听状态</li>
<li>客户端调用connect（）发起连接</li>
<li>服务器内核为每个Socket维护了两个队列<ol>
<li>TCP半连接队列：还没有完成三次握手</li>
<li>TCP全连接队列：完成三次握手</li>
</ol>
</li>
<li>服务端accept（）函数，从内核获取客户端的连接</li>
</ol>
<img src="https://raw.githubusercontent.com/cccccc96/cloudimg/main/image-20240721104533722.png" alt="image-20240721104533722" style="zoom:33%;" />

<h3 id="如何服务更多用户"><a href="#如何服务更多用户" class="headerlink" title="如何服务更多用户"></a>如何服务更多用户</h3><ol>
<li>服务器单机理论多大连接多少客户端</li>
</ol>
<p>TCP连接：本机IP，本机端口，对端IP，对端端口</p>
<p>最大TCP连接数：客户端IP数客户端IP数（2 ^ 32）* 客户端端 口数（2 ^ 16 ）&#x3D;2^48</p>
<p>但注定不能这么多：文件描述符、系统内存</p>
<p>C10k，并发1万请求，从硬件角度来说，2g千兆网卡，只需要保证每条请求200kb的内存和100kb的带宽。</p>
<ol>
<li>实际不行</li>
</ol>
<p>因为上面最基本的Socket，同步阻塞，只能满足一对一通信</p>
<ul>
<li>服务端还没处理完一个客户端的IO</li>
<li>读写操作发生阻塞</li>
</ul>
<p>其他客户端都无法与服务端连接</p>
<h3 id="多线程模型"><a href="#多线程模型" class="headerlink" title="多线程模型"></a>多线程模型</h3><p>父进程只负责accept（）建立连接</p>
<p>线程池负责读写</p>
<p>C10K，代表要维护1万个线程，操作系统不可能扛得住</p>
<h3 id="IO多路复用-1"><a href="#IO多路复用-1" class="headerlink" title="IO多路复用"></a>IO多路复用</h3><p>使用一个进程来维护多个Socket，这就是I&#x2F;O多路复用。</p>
<p>我们熟悉的 select&#x2F;poll&#x2F;epoll 内核提供给用户态的多路复用系统调用</p>
<ul>
<li>进程可以通过一个系统调用函数从内核中获取多个事件。</li>
</ul>
<p>select&#x2F;poll&#x2F;epoll 是如何获取网络事件？</p>
<ul>
<li>先把所有连接传给内核，之后内核返回产生了事件的连接</li>
</ul>
<h3 id="Select-poll"><a href="#Select-poll" class="headerlink" title="Select&#x2F;poll"></a>Select&#x2F;poll</h3><ol>
<li>将已连接的Socket都放到一个文件描述符集合</li>
<li>调用Select集合拷贝到内核</li>
<li>内核检查是否有网络事件产生<ol>
<li>遍历文件描述符集合，检查到有事件发生，标记Socket可读、可写</li>
</ol>
</li>
<li>再将整个描述符集合拷贝回用户</li>
<li>用户态遍历文件描述符集合找到可读、可写的Socket，再对其处理。</li>
</ol>
<p>两次遍历，两次拷贝，文件描述符集合</p>
<p>Select、Poll区别：一个用固定长度的BitsMap；一个用动态数组，链表</p>
<p>采用线性集合存储Socket集合，时间复杂度为O（n），也需要再用户态与内核态之间拷贝文件描述集合</p>
<h3 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h3><p>epoll 通过两个方面，很好解决了 select&#x2F;poll 的问题。</p>
<ol>
<li>epoll在内核中用红黑树跟踪进程所有待检测的文件描述字。只需要传入一个待检测的socket，不用每次传入整个socket集合，避免大量拷贝</li>
<li>使用事件驱动的机制，内核里维护了一个链表记录就绪事件，每当有事件发生，通过回调函数将其加入到就绪事件列表，当用户调用 <code>epoll_wait()</code> 函数时，只会返回有事件发生的文件描述符的个数，不需要轮询扫描。</li>
</ol>
<img src="https://raw.githubusercontent.com/cccccc96/cloudimg/main/image-20240721104607391.png" alt="image-20240721104607391" style="zoom: 50%;" />

<p>边缘触发和水平触发</p>
<ul>
<li>边缘触发：当被Socket描述符上有可读事件发生，服务器端只会从epoll_wait中苏醒一次，因此一次性将内核中的数据读取完<ul>
<li>epoll</li>
<li>边缘触发模式一般和非阻塞 I&#x2F;O 搭配使用</li>
<li>边缘触发的效率比水平触发的效率要高，减少 epoll_wait</li>
</ul>
</li>
<li>水平触发：当被监控的 Socket 上有可读事件发生时，服务器端不断地从 epoll_wait 中苏醒，直到内核缓冲区数据被 read 函数读完才结束<ul>
<li>select、poll、epoll默认</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/bagu/JWT%E8%BF%98%E6%98%AFcookie/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/bagu/JWT%E8%BF%98%E6%98%AFcookie/" class="post-title-link" itemprop="url">【1开发】【八股】JWT</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E5%85%AB%E8%82%A1/" itemprop="url" rel="index"><span itemprop="name">八股</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h2><h4 id="1-无状态"><a href="#1-无状态" class="headerlink" title="1 无状态"></a>1 无状态</h4><p>简化验证流程，JWT自身包含了身份验证所需要的所有信息（用户身份，有效期），服务器端不需要存储Session信息，大大减轻了服务器端的压力</p>
<h4 id="2-有效避免CSRF（跨站请求伪造）"><a href="#2-有效避免CSRF（跨站请求伪造）" class="headerlink" title="2 有效避免CSRF（跨站请求伪造）"></a>2 有效避免CSRF（跨站请求伪造）</h4><p>某个链接中藏了一个请求，那么只要发出请求，cookie就会被携带，借助这个特性</p>
<h4 id="3-移动端应用"><a href="#3-移动端应用" class="headerlink" title="3 移动端应用"></a>3 移动端应用</h4><p>移动端应用管理和维护Cookie比较复杂</p>
<h4 id="4-单点登录友好"><a href="#4-单点登录友好" class="headerlink" title="4 单点登录友好"></a>4 单点登录友好</h4><p>需要常见的cookie跨域问题</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><h4 id="注销登录"><a href="#注销登录" class="headerlink" title="注销登录"></a>注销登录</h4><p>无法注销，通过Redis存储</p>
<h4 id="续签问题"><a href="#续签问题" class="headerlink" title="续签问题"></a>续签问题</h4><p>无法动态刷新</p>
<ul>
<li>每次进行校验时，重新生成JWT返回给客户端</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/bagu/redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/bagu/redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" class="post-title-link" itemprop="url">【1开发】【八股】Redis分布式锁</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E5%85%AB%E8%82%A1/" itemprop="url" rel="index"><span itemprop="name">八股</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Redis分布式锁"><a href="#Redis分布式锁" class="headerlink" title="Redis分布式锁"></a>Redis分布式锁</h1><p>Redis是基于内存操作，性能极高。</p>
<p>考虑如果没有reddsion，用setIfAbsent</p>
<h4 id="方案1-（直接加锁）"><a href="#方案1-（直接加锁）" class="headerlink" title="方案1 （直接加锁）"></a>方案1 （直接加锁）</h4><p>如果缓存里没有数据，就加锁。加锁成功就访问，反之就自旋重新拿数据。</p>
<p>缺点：虽然设置了<strong>过期时间</strong>，但当业务执行完成之后，我们的锁还持有着。我们<strong>希望的是业务执行完之后，立即释放锁</strong>。</p>
<h4 id="方案2（finally删除锁）"><a href="#方案2（finally删除锁）" class="headerlink" title="方案2（finally删除锁）"></a>方案2（finally删除锁）</h4><p>在方案1的基础之上，加一行finally删除锁。</p>
<p>缺点：假如过期时间比较短，B已经获取了锁，那么<strong>A执行完之后可能会释放B的锁</strong></p>
<h4 id="方案3（锁设置一个value值）"><a href="#方案3（锁设置一个value值）" class="headerlink" title="方案3（锁设置一个value值）"></a>方案3（锁设置一个value值）</h4><p>在方案2的情况下，加锁的时候，设置一个value值。</p>
<p>缺点：如何设置过期时间值</p>
<ul>
<li>太短：业务还没有执行完，就执行完了</li>
<li>太长：节点宕机了， 其他节点一直获取不到锁</li>
</ul>
<p><strong>看门狗</strong>：<strong>守护线程</strong>，隔固定时间去查看业务是否执行完毕，如果没有就<strong>续期</strong>。</p>
<h4 id="方案4（Reddision-trylock）"><a href="#方案4（Reddision-trylock）" class="headerlink" title="方案4（Reddision trylock）"></a>方案4（Reddision trylock）</h4><p>解决了前三个方案的问题：</p>
<ul>
<li>锁过期问题，释放他人的锁</li>
<li>看门狗机制：默认锁过期时间是30s，会有一个定时任务在每10s去扫描一下该锁是否被释放，如果没有释放就延长至30s</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/kaifa/bagu/springAOP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蔡正海">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="czh的学习小站">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | czh的学习小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/kaifa/bagu/springAOP/" class="post-title-link" itemprop="url">【1开发】【八股】springAOP</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/%E5%85%AB%E8%82%A1/" itemprop="url" rel="index"><span itemprop="name">八股</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="什么是AOP"><a href="#什么是AOP" class="headerlink" title="什么是AOP"></a>什么是AOP</h2><p>AOP（Aspect Oriented Programming）即面向切面编程。将把一些业务逻辑中的相同代码从核心业务逻辑中分离出来。</p>
<p>如何实现呢？</p>
<ul>
<li>Aspect（切面）：</li>
<li>Join Point（连接点）：被拦截到的方法</li>
<li>PointCut（切点）：定位</li>
<li>Advice（通知）：Before&#x2F;Around&#x2F;After</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span> 切面</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DBRouterJoinPoint</span> &#123;</span><br><span class="line">		<span class="comment">// Pointcut 切点，定位</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;@annotation(cn.bugstack.middleware.db.router.annotation.DBRouter)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">aopPoint</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Around 通知，环绕</span></span><br><span class="line">    <span class="meta">@Around(&quot;aopPoint() &amp;&amp; @annotation(dbRouter)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">doRouter</span><span class="params">(ProceedingJoinPoint jp, DBRouter dbRouter)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        .......</span><br><span class="line">        <span class="type">String</span> <span class="variable">dbKeyAttr</span> <span class="operator">=</span> getAttrValue(dbKey, jp.getArgs());</span><br><span class="line">        dbRouterStrategy.doRouter(dbKeyAttr);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> jp.proceed();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           dbRouterStrategy.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="怎么实现的-–-动态代理"><a href="#怎么实现的-–-动态代理" class="headerlink" title="怎么实现的 – 动态代理"></a>怎么实现的 – 动态代理</h3><p>啥是代理，以静态代理说明：代理类和目标类实现相同的接口，然后代理类里面维护一个目标类就完事了。</p>
<p>那么spring AOP中的动态代理包含两类：默认如果使用接口的，用 JDK 提供的动态代理实现，如果是方法则使用 CGLIB 实现</p>
<h4 id="1-JDK动态代理（缺点，只能代理接口）"><a href="#1-JDK动态代理（缺点，只能代理接口）" class="headerlink" title="1. JDK动态代理（缺点，只能代理接口）"></a>1. JDK动态代理（缺点，只能代理接口）</h4><p>通过java.lang.reflect.Proxy来实现（反射）</p>
<ul>
<li>InvocationHandler + invoke</li>
</ul>
<p>所以，AOP创建一个代理对象，在方法调用前后插入横切逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Service</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">perform</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">Service</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">perform</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Performing service...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceInvocationHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Object target;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceInvocationHandler</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Before method&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> method.invoke(target, args);</span><br><span class="line">        System.out.println(<span class="string">&quot;After method&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Service</span> <span class="variable">service</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServiceImpl</span>();</span><br><span class="line">        <span class="type">Service</span> <span class="variable">proxy</span> <span class="operator">=</span> (Service) Proxy.newProxyInstance(</span><br><span class="line">            service.getClass().getClassLoader(),</span><br><span class="line">            service.getClass().getInterfaces(),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ServiceInvocationHandler</span>(service)</span><br><span class="line">        );</span><br><span class="line">        proxy.perform();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="2-CGLIB-动态代理（可以代理类）"><a href="#2-CGLIB-动态代理（可以代理类）" class="headerlink" title="2. CGLIB 动态代理（可以代理类）"></a>2. CGLIB 动态代理（可以代理类）</h4><p>基于ASM操作字节码。需要cglib库,MethodInterceptor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProxyFactory</span> <span class="keyword">implements</span> <span class="title class_">MethodInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//维护一个目标对象</span></span><br><span class="line">    <span class="keyword">private</span> Object target;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ProxyFactory</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//为目标对象生成代理对象</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getProxyInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//工具类</span></span><br><span class="line">        <span class="type">Enhancer</span> <span class="variable">en</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Enhancer</span>();</span><br><span class="line">        <span class="comment">//设置父类</span></span><br><span class="line">        en.setSuperclass(target.getClass());</span><br><span class="line">        <span class="comment">//设置回调函数</span></span><br><span class="line">        en.setCallback(<span class="built_in">this</span>);</span><br><span class="line">        <span class="comment">//创建子类对象代理</span></span><br><span class="line">        <span class="keyword">return</span> en.create();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Object obj, Method method, Object[] args, MethodProxy proxy)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;请问有什么可以帮到您？&quot;</span>);</span><br><span class="line">        <span class="comment">// 执行目标对象的方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">returnValue</span> <span class="operator">=</span> method.invoke(target, args);</span><br><span class="line">        System.out.println(<span class="string">&quot;问题已经解决啦！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="SpringAOP和AspectJ啥区别"><a href="#SpringAOP和AspectJ啥区别" class="headerlink" title="SpringAOP和AspectJ啥区别"></a>SpringAOP和AspectJ啥区别</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2022 - 2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">蔡正海</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  



  <script src="/js/third-party/fancybox.js"></script>



  





</body>
</html>
